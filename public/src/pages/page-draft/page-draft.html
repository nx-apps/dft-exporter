<link rel="import" href="components/list-company.html">
<link rel="import" href="components/detail-company.html">
<link rel="import" href="components/fileup-company.html">
<link rel="import" href="components/register-page.html">
<link rel="import" href="./../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../nylon-behavior.html">
<link rel="import" href="../components/panel-right/panel-right.html">
<link rel="import" href="./../../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="./../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="./../../../bower_components/gl-styles/gl-size.html">
<link rel="import" href="./../../../bower_components/gl-styles/gl-color.html">
<link rel="import" href="./../../../bower_components/gl-styles/gl-table.html">
<!--<link rel="import" href="./../../../bower_components/gl-styles/gl-panel.html">-->
<link rel="import" href="./../../../bower_components/gl-styles/gl-toast.html">
<link rel="import" href="./../../../bower_components/gl-form/gl-form-input.html">
<link rel="import" href="./../../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="./../../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="./../../../bower_components/paper-tabs/paper-tab.html">
<link rel="import" href="./../../../bower_components/gl-form/gl-form-panel.html">
<link rel="import" href="./../../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="./../../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="./../../../bower_components/gl-grid/gl-grid-col.html">
<link rel="import" href="./../../../bower_components/gl-grid/gl-grid-row.html">
<link rel="import" href="./../../../bower_components/gl-form/gl-form-textarea.html">
<link rel="import" href="./../../../bower_components/gl-form/gl-form-dropdown-menu.html">
<link rel="import" href="./../../../bower_components/gl-form/gl-form-input.html">
<link rel="import" href="./../../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="./../../../bower_components/paper-item/paper-item.html">


<link rel="import" href="../components/validateFormBehaviors.html">

<link rel="import" href="./components/detail-company.html">

<link rel="import" href="../../redux-behavior.html">

<link rel="import" href="../../nylon-behavior.html">

<link rel="import" href="../../i18n-behavior.html">

<link rel="import" href="../../action/exporterAction.html">

<link rel="import" href="../../action/confirmAction.html">

<link rel="import" href="../../layout/page-style.html">


<dom-module id="page-draft">
  <style is="custom-style" include="page-style iron-flex iron-flex-factors iron-flex-alignment gl-size gl-color gl-table gl-toast">
    * {
      font-family: 'CSChatThaiUI', sans-serif;
      -webkit-font-smoothing: antialiased;
    }

    .marginCheckbox {
      margin: 10px 0px 0px 30px;
    }

    .gl-btn-defalse {
      background-color: #FFF;
      color: black;
      min-height: var(--gl-btn-min-hight);
      min-width: var(--gl-btn-min-width);
      margin: var(--gl-btn-margin);
    }

    .searchBorder {
      border: 1px solid var(--gl-gray-light-color);
      margin: 15px;
      border-radius: 3px;
      background-color: #fff;
    }

    .text-table {
      text-align: center;
      font-size: var(--font-size-h5);
    }

    .gl-table-default {
      border-collapse: collapse;
      width: 100%;
      white-space: nowrap;
    }

    .tabs {
      background-color: #f7941e;
      margin: 0px 15px 0px 15px;
      color: #F2F2F2;
      --paper-tabs-selection-bar: {
        height: 5px;
        background-color: var(--gl-info-color);
      }
    }

    .tab:focus>div.tab-content {
      background-color: yellow;
      opacity: 1;
      font-weight: 0;
    }

    .tab:not(:last-of-type) {
      border-right: 3px solid var(--gl-gray-light-color);
      font-size: var(--font-size-h5);
    }

    .tabs .tab.iron-selected {
      font-size: var(--font-size-h5);
      color: var(--gl-white-color);
      background-color: var(--gl-info-color);
    }

    .table-head>tr>th:nth-child(2) {
      width: 15%;
    }

    .btn {
      margin: 15px 20px 5px 10px;
    }

    .btn-bottom {
      margin: 0px 15px 15px 0px;
    }


    .container {
      display: inline-block;
      margin-left: 30px;
      margin-right: 30px;
    }
    /* Need to position the badge to look like a text superscript */

    .container>paper-badge {
      --paper-badge-margin-left: 20px;
      --paper-badge-margin-bottom: 0px;
    }

    .btn-back {
      margin: 30px 30px 0px 0px;
    }

    paper-material {
      background-color: var(--gl-white-color);
      padding: 15px;
      margin-top: 15px;
      /*height: */
    }

    .head-title {
      text-align: center;
      font-size: var(--font-size-h3);
      margin-top: 15px;
    }

    .searchBox {
      padding: 5px;
      background-color: var(--gl-gray-lighter-color);
    }

    .searchBorder {
      border: 1px solid var(--gl-gray-light-color);
      margin: 15px;
      border-radius: 3px;
    }

    main {
      padding: 5px;
      margin: 0 auto;
    }

    section {
      display: none;
      border-top: 1px solid #ddd;
    }

    input {
      display: none;
    }

    label {
      display: inline-block;
      margin: 0 0 -1px;
      padding: 15px 25px;
      font-weight: 600;
      text-align: center;
      color: #bbb;
      border: 1px solid transparent;
      background: #D5D8DC;
    }

    label:before {
      font-family: fontawesome;
      font-weight: normal;
      margin-right: 10px;
    }

    label:hover {
      color: #888;
      cursor: pointer;
    }

    input:checked+label {
      color: #555;
      border: 1px solid #ddd;
      border-top: 3px solid orange;
      border-bottom: 1px solid #fff;
      background: #fff;
    }

    #tab1:checked~#content1,
    #tab2:checked~#content2 {
      display: block;
    }

    detail-company,
    fileup-company {
      margin-top: 15px;
      width: 98%;
    }

    .container {
      display: inline-block;
      margin-left: 30px;
      margin-right: 30px;
    }

    table.gl-table-default {}

    table.gl-table-default>tbody.table-body>tr>td {
      /*cursor: pointer;*/
      padding: 10px 15px;
    }
  </style>
  <template>
    <paper-material elevation="1" class="elevation">


      <!--<div class="horizontal end-justified layout btn-back">
        <paper-button class="button-top gl-btn-defalse" raised on-tap="goBack"> ย้อนกลับ </paper-button>
      </div>-->

      <div class="horizontal end-justified layout">
        <div>
          <paper-button class="button-top gl-btn-success" raised on-tap="registerdraft"> สมัคร</paper-button>
        </div>
        <div>
          <paper-button class="button-top gl-btn-primary" raised on-tap="renewdraft"> ต่ออายุ</paper-button>
        </div>
        <div>
          <paper-button class="button-top gl-btn-warning" raised on-tap="changedraft"> เปลี่ยนประเภท</paper-button>
        </div>
      </div>
      </div>
      <div class="head-title">จัดการทะเบียนผู้ส่งออกข้าว</div>
      <div class="horizontal layout center-justified searchBox searchBorder" style="margin-top:10px;">
        <gl-form-input class="searchForm" hidden="{{isHidden}}" style="width:300px;" label="{{localize.tax_no}} :" value="{{companyId}}"
          always-float-label allowed-pattern="[0-9]" maxlength="13">
          <iron-icon icon="search" prefix style="width:20px;height:30px;"></iron-icon>
          <paper-icon-button suffix on-tap="clearData" icon="clear" title="clear" style="height:30px;">
        </gl-form-input>
        <paper-button hidden="{{isHidden}}" class="gl-btn-info btn" raised on-tap="_search">{{localize.bt_search}}</paper-button>
      </div>
      <div name="listCompany">
        <div class="searchBorder" style="overflow-x:auto;">
          <table class="gl-table-default">
            <thead class="table-head">
              <tr>
                <th>
                  <div class="text-table">{{localize.No}}</div>
                </th>
                <th>
                  <div class="text-table">{{localize.no_exporter_fullname}}</div>
                </th>
                <th>
                  <div class="text-table">{{localize.name_company}}</div>
                </th>
                <th>
                  <div class="text-table">{{localize.type_license}}</div>
                </th>
                <th>
                  <div class="text-table">{{localize.date_register}}</div>
                </th>
                <th>
                  <div class="text-table">{{localize.status}}</div>
                </th>
              </tr>
            </thead>

            <template is="dom-repeat" items="{{companys}}">
              <tbody>
                <tr style="cursor:pointer;">
                  <td>
                    <div class="text-table">[[indexNo(index)]]</div>
                  </td>
                  <td style="text-align:center">
                    {{item.lic_type.lic_type_prefix}}{{item.exporter_no}}
                  </td>
                  <td on-tap="_selectData" data="[[item]]">
                    <div>{{item.company.company_name_th}}</div>
                  </td>
                  <td on-tap="_selectData" data="[[item]]">
                    <div>{{item.lic_type.lic_type_name}}</div>
                  </td>
                  <td on-tap="_selectData" data="[[item]]">
                    <div class="text-table">{{changeDate(item.date_created)}}</div>
                  </td>
                  <td on-tap="_selectData" data="[[item]]">
                    <div>{{obDraftStatus(item.draft_status, item.doc_status, item.approve_status)}}</div>
                  </td>
                </tr>
            </template>
            <template is="dom-if" if={{_checkData(companys)}}>
              <tr>
                <td colspan="6">
                  <div class="text-table" style="margin:20px">{{localize.not_found}}</div>
                </td>
              </tr>
            </template>
            </tbody>
          </table>
        </div>
      </div>

    </paper-material>

    <panel-right title="{{titleName}}">
      <div class="left">

        <iron-pages selected="{{layerContent}}" attr-for-selected="name">
          <div name="register">
            <register-page></register-page>
          </div>
          <div name="approve">
            <main>
              <input id="tab1" type="radio" name="tabs" checked>
              <label for="tab1">
                    <div class="container" tabindex="0">
                      <span>1.{{localize.detail}}</span>
                    </div>
                  </label>

              <input id="tab2" type="radio" name="tabs">
              <label for="tab2">
                  <div class="container" tabindex="0">
                    <span>2.{{localize.doc_ev}}</span>
                    </div>
                  </label>


              <section id="content1">
                <gl-form-panel>
                  <detail-company id="detailCompany" data={{resultCompany}}></detail-company>
                  <table class="gl-table-default" style="width: 100%;border: 1px solid #ddd; margin: 20px 0px 10px 0px;">
                    <thead class="table-head">
                      <tr>
                        <th style="width :20%">ลำดับที่</th>
                        <th style="width :30%">สถานะการดำเนินงาน</th>
                        <th style="width : 30%">วันที่</th>
                      </tr>
                    </thead>
                    <tbody class="table-body">
                      <template is="dom-repeat" items="{{resultCompany.remark}}">
                        <tr>
                          <td>[[indexNo(index)]]</td>
                          <td>[[item.msg]]</td>
                          <td>[[changeDate(item.date)]]</td>
                        </tr>
                      </template>

                      <template is="dom-if" if={{checkArrayEmpty(resultCompany.remark)}}>
                        <tr>
                          <td colspan=3 style="text-align:center">ไม่มีข้อมูล</td>
                        </tr>
                      </template>
                    </tbody>
                  </table>
                  <div class="horizontal end-justified layout" style="margin:10px">
                    <paper-button raised class="gl-btn-primary" on-tap="reSendDoc" hidden="[[_BtnShowReSend(resultCompany)]]">
                      <iron-icon icon="add"></iron-icon>ส่งเอกสารใหม่</paper-button>
                    <paper-button raised class="gl-btn-danger" on-tap="rejectDoc" hidden="[[_BtnShowDoc(resultCompany)]]">
                      <iron-icon icon="add"></iron-icon>รอตรวจเอกสาร (ไม่ผ่าน)</paper-button>
                    <paper-button raised class="gl-btn-primary" on-tap="approveDoc" hidden="[[_BtnShowDoc(resultCompany)]]">
                      <iron-icon icon="add"></iron-icon>รอตรวจเอกสาร (ผ่าน)</paper-button>
                    <paper-button raised class="gl-btn-danger" on-tap="rejectApprove" hidden="[[_BtnShowApprove(resultCompany)]]">
                      <iron-icon icon="add"></iron-icon>รออนุมัติ (ไม่ผ่าน)</paper-button>
                    <paper-button raised class="gl-btn-primary" on-tap="waitaApprove" hidden="[[_BtnShowApprove(resultCompany)]]">
                      <iron-icon icon="add"></iron-icon>รออนุมัติ (ผ่าน)</paper-button>
                  </div>
                </gl-form-panel>
              </section>

              <section id="content2">
                <gl-form-panel>
                  <fileup-company></fileup-company>
                </gl-form-panel>
              </section>

            </main>
          </div>
          <div name="renew">
            <register-page></register-page>
          </div>
          <div name="changedraft">
            <register-page></register-page>
          </div>
        </iron-pages>
      </div>
    </panel-right>
    <paper-dialog id="rejectDoc">
      <h2>เหตุผล</h2>
      <paper-dialog-scrollable>
        <div style="margin:10px 30px;">
          <gl-form-input label="เหตุผลที่ไม่ผ่าน" value="{{docReason}}"></gl-form-input>
        </div>
      </paper-dialog-scrollable>
      <div class="buttons">
        <paper-button dialog-dismiss raised class="gl-btn-defalse">ปิด</paper-button>
        <paper-button dialog-confirm autofocus on-tap="__rejectDocDia" raised class="gl-btn-primary">ตกลง</paper-button>
      </div>
    </paper-dialog>
  </template>
  <script>
    Polymer({
      is: "page-draft",
      properties: {
        pages: {
          type: String,
          value: 0
        },
        layerContent: {
          type: String,
          value: 'register'
        },
        isHidden: {
          type: Boolean,
          value: false
        },
        localize: {
          statePath: 'i18n.exporter'
        },
        data: {
          statePath: 'confirm.data'
        },
        companys: {
          statePath: 'confirm.list'
        },
        draftById: {
          statePath: 'confirm.draftById',
          observer: 'setDataDraft'
        }
      },
      behaviors: [ReduxBehavior, nylonBehavior, i18nAction, confirmAction, exporterAction, ValidateFormBehavior],
      listeners: {
        'back_page': '_backPage',
        'clearData': 'clearData'
      },
      goBack() {
        this.fire('nylon-change-page', { path: '/admin-exporter' })
      },
      setDataDraft(data) {
        // console.log(data.lic_type);
        this.set('resultCompany', data)
        // console.log(this.resultCompany);
      },
      nylonPageActive: function () {

        this.dispatchAction('CONFIRM_GET_DATA');
        // this.dispatchAction('EXPORTER_GET_LIC_TYPE');
        // this.dispatchAction('EXPORTER_GET_DOC_TYPE');
      },
      _selectData: function (e) {
        let data = e.currentTarget.data
        this.dispatchAction('CONFIRM_SEARCH_DRAFT', data.id)
        this.set('layerContent', 'approve')

        this.$$('panel-right')

        this.$$('panel-right').open();
      },
      _backPage: function (data) {
        // this.pageSelected = 'listCompany';
        this.pages = 0;
        this.isHidden = false;
      },
      checkArrayEmpty(arr) {
        // console.log(arr);
        if (arr === undefined || arr.length === 0) {
          // console.log(1);
          return true
        } else {
          // console.log(2);
          return false
        }
        // console.log(arr);
      },
     
     
      _print: function (e) {
        // console.log(e.target.getAttribute('report'));
        if (e.target.getAttribute('report') == 'report1') {
          // console.log(this.data.draft_status);
          if (this.data.draft_status == 'sign') {
            window.open('./api/external/report_exporter/approve_general_1/' + this.data.id);
          } else if (this.data.draft_status == 'type') {
            window.open('./api/external/report_exporter/approve_changtype/' + this.data.id);
          } else {
            window.open('./api/external/report_exporter/approve_renew_1/' + this.data.id);
          }
        } else {
          if (this.data.draft_status == 'sign') {
            window.open('./api/external/report_exporter/approve_general_2/' + this.data.id);
          } else {
            window.open('./api/external/report_exporter/approve_renew_2/' + this.data.id);
          }
        }

      },
      _search: function () {
        if (this.companyId != '') {
          this.dispatchAction('CONFIRM_SEARCH', this.companyId);
          // this.pageSelected = "register";

          this.queryFrom('.searchForm').map((el) => { el.reset(); });
        }
        else {
          this.fire('toast', { status: 'connectError', text: 'กรุณากรอกเลขประจำตัวผู้ส่งออก' })
        }
      },
      clearData: function () {
        this.idCompany = {};
        this.companyId = '';
        this._backPage();
      },
      indexNo: function (val) {
        return val + 1
      },
      _checkData: function (val) {
        if (val.length > 0) {
          return false
        } else {
          return true
        }
      },
      obDraftStatus: function (data, doc_status, approve_status) {
        if (data == 'change') {
          return 'เปลี่ยนประเภทใบอนุญาต (รออนุมัติ)'
        }
        if (data == 'renew') {
          return 'ต่ออายุ (รออนุมัติ)'
        }
        if (data == 'sign') {
          if (doc_status === false) {
            return 'เอกสารไม่ผ่าน'
          }
          if (doc_status === null && approve_status === false) {
            return 'ลงทะเบียน (ตรวจสอบเอกสาร)'
          }
          else if (doc_status === true && approve_status === false) {
            return 'ลงทะเบียน (รออนุมัติ)'
          }
        }
      },
      checkStatusExtend: function (val) {
        if (val == 'renew') {
          return true
        } else {
          return false
        }
      },
      // --------------------------------------------------------------------------------------
      registerdraft: function (e) {
        this.set('layerContent', 'register')
        this.dispatchAction('CONFIRM_SEARCH_RESET')
        this.dispatchAction('CONFIRM_TYPE', 'registerdraft')
        console.log(1);
        this.$$('panel-right').open();
        this.set('titleName', 'สมัคร')
      },
      renewdraft: function (e) {
        console.log(2);
        this.set('layerContent', 'renew')

        this.$$('panel-right').open();
        this.dispatchAction('CONFIRM_SEARCH_RESET')
        this.dispatchAction('CONFIRM_TYPE', 'renewdraft')
        this.set('titleName', 'ต่ออายุ')
      },
      changedraft: function (e) {
        console.log(3);
        this.set('layerContent', 'changedraft')

        this.$$('panel-right').open();
        this.dispatchAction('CONFIRM_SEARCH_RESET')
        this.dispatchAction('CONFIRM_TYPE', 'changedraft')
        this.set('titleName', 'เปลี่ยนประเภท')
      },
      changeDate(date) {
        let time = new Date(date)
        date = new Date(time.setHours(time.getHours() + 7)).toISOString()
        date = date.split("T")[0]
        return date
      },
      _docAndApproce(remarkText, diaText, isDoc) {
        this.draftById.remark.map((item) => {
          let time = new Date(item.date)
          let date = new Date(time.setHours(time.getHours() + 7)).toISOString()
          item.date = date.split("T")[0] + 'T00:00:00+07:00'
          return item
        })
        let remark = {
          msg: remarkText,
          date: new Date().toISOString().split('T')[0] + 'T00:00:00+07:00'
        }
        this.push('draftById.remark', remark)
        let newData = {}

        if (isDoc.hasOwnProperty('doc_status')) {
          // console.log(isDoc);
          newData = {
            id: this.draftById.id,
            remark: this.draftById.remark,
            doc_status: isDoc.doc_status
          }
          // console.log(1);
        } else {
          newData = {
            id: this.draftById.id,
            remark: this.draftById.remark,
            approve_status: isDoc.approve_status
          }
          // console.log(2);
        }
        // console.log(newData);
        this.fire('toast', {
          status: 'openDialog',
          text: diaText,
          confirmed: (result) => {
            if (result == true) {
              this.dispatchAction('CONFIRM_DOC_AND_APPROVE', newData)
                .then((res) => {
                  this.dispatchAction('CONFIRM_SEARCH_DRAFT', newData.id);
                  this.nylonPageActive()
                })
                .catch((err) => {
                  console.log(err);
                })
            }
          }
        })
        // console.log(remark, diaText, isDoc);
      },
      reSendDoc() {
        this._docAndApproce('ส่งเอกสารใหม่', 'ยื่นยัการส่งอีกรอบ ใช่รึไหม ?', { doc_status: null })

      },
      rejectDoc() {
        this.$.rejectDoc.open()
      },
      __rejectDocDia() {
        this._docAndApproce(this.docReason || '', 'ไม่ผ่านใช่รึไหม ?', { doc_status: false })

      },
      approveDoc() {
        this._docAndApproce('เอกสารผ่าน' || '', 'เอกสารผ่านใช่รึไหม ?', { doc_status: true })

      },
      rejectApprove() {
        this.rejectDoc()
        // console.log(this.draftById);
      },
      waitaApprove() {
        this._docAndApproce('อนุมัติแล้ว' || '', 'ต้องการอนุมัติ ใช่รึไม่ ?', { approve_status: true })
      },
      _BtnShowReSend(resultCompany) {
        if (resultCompany.doc_status === false && resultCompany.approve_status === false)
          return false
        return true
      },
      _BtnShowDoc(resultCompany) {
        if (resultCompany.doc_status === null && resultCompany.approve_status === false)
          return false
        return true
      },
      _BtnShowApprove(resultCompany) {
        if (resultCompany.doc_status === true && resultCompany.approve_status === false)
          return false
        return true
      }
    });
  </script>
</dom-module>