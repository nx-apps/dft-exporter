<link rel="import" href="../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../layout/shared-styles.html">
<link rel="import" href="../../../nylon-behavior.html">
<link rel="import" href="../../../redux-behavior.html">
<link rel="import" href="../../components/page-header.html">
<link rel="import" href="../../components/page-panel.html">
<link rel="import" href="../../../../bower_components/vaadin-combo-box/vaadin-combo-box.html">
<link rel="import" href="../../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="./../../components/nylon-input.html">
<link rel="import" href="./../../components/format-number-behavior.html">
<link rel="import" href="./../../../../bower_components/pdf-browser-viewer/pdf-browser-viewer.html">
<link rel="import" href="./../../../../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="./../../../../bower_components/vaadin-date-picker/vaadin-date-picker.html">
<link rel="import" href="./../../../../bower_components/paper-item/paper-item.html">
<link rel="import" href="./../../../../bower_components/iron-a11y-keys/iron-a11y-keys.html">
<link rel="import" href="../../../month-behavior.html">
<link rel="import" href="./exporter-report-upload.html">
<link rel="import" href="./../../components/input-item.html">

<dom-module id="exporter-report-form">
    <template>
        <style include="shared-styles">
            vaadin-grid {
                height: 500px;
            }
            .size{
                height: auto;
                max-height: 150px;
                overflow-y: auto;
            }
            .border {
                border: 1px solid #ddd;
            }

            #sub1:checked~#subcontent1,
            #sub2:checked~#subcontent2,
            #sub3:checked~#subcontent3 {
                display: block;
            }

            .panel {
                padding: 20px;
                border: 1px solid #ddd;
            }
        </style>
        <!--<page-panel label="แสดงไฟล์">-->
        <div class="row around-xs">
            <div class="col-xs-6">
                <div class="box">
                    กำลังแสดงไฟล์ : [[file.name]]
                    <template is="dom-if" if="[[checkPath(file.path)]]">
                        <button on-tap="fileOpen">open</button>
                    </template>
                </div>
                <div class="box">
                    <pdf-browser-viewer id="pdfViewer" file="[[file.path]]" not-supported-message="Not supported by your browser" not-supported-link-message="see the file here!"
                        height="850px" width="100%">
                    </pdf-browser-viewer>
                </div>
            </div>
            <div class="col-xs-6">
                <div class="box">
                    <main>
                        <input class="radio" id="sub2" type="radio" name="sub" value="false" checked>
                        <label for="sub2">แบบฟอร์มนำเข้าข้อมูล</label>

                        <input class="radio" id="sub1" type="radio" name="sub" value="true">
                        <label for="sub1">จัดการไฟล์</label>

                        <section id="subcontent1">
                            <exporter-report-upload select="[[form]]" id="uploadFile"></exporter-report-upload>
                            <!--</page-panel>-->
                        </section>

                        <section id="subcontent2">
                            <div class="panel">
                                <div class="row">
                                    <div class="col-xs-12">
                                        <div class="box">
                                            <vaadin-combo-box class="saveData" label="รายงานการส่งออกข้าวไป EU" items="{{listEu}}" value="{{form.quota}}" error-message="กรุณาเลือกรายการ"
                                                item-label-path="name" item-value-path="id" required></vaadin-combo-box>
                                        </div>
                                    </div>
                                    <!-- <div class="col-xs-12 col-md-6">
                                         <div class="box">
                                             <vaadin-combo-box label="เดือนที่รายงาน" items="{{getMonth()}}" item-label-path="name" item-value-path="id" value="{{form.month}}"></vaadin-combo-box> 
                                        </div>
                                    </div> -->
                                     <div class="col-xs-12">
                                        <div class="box">
                                            <vaadin-combo-box items="[[year]]" label="ปีโควตา" error-message="กรุณาเลือกปี" value="{{form.year}}" required></vaadin-combo-box>
                                        </div>
                                    </div> 
                                    <div class="col-xs-12">
                                        <div class="box">
                                            <vaadin-combo-box label="บริษัท" loading="{{check}}" filter="{{word}}" items="[[company]]" item-label-path="company_name_th" item-value-path="company_taxno" value="{{form.exporter_id}}">
                                                <template>
                                                    [[item.company_name_th]]
                                                </template> 
                                            </vaadin-combo-box>
                                            <!-- <input-item id="valExporter" label="กรอกชื่อบริษัท" value="{{form.exporter_name}}"></input-item>  -->
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-xs-12">
                                        <div class="box">
                                            <vaadin-combo-box label="ความถูกต้องของเอกสาร" items="[[checkDoc]]" item-label-path="name" item-value-path="id" value="{{form.type_doc}}"
                                            required></vaadin-combo-box>
                                        </div>
                                    </div>
                                    <div class="col-xs-12 col-md-6">
                                        <div class="box">
                                            <nylon-input label="เลขที่รับ" value="{{form.number}}"></nylon-input>
                                        </div>
                                    </div>
                                    <div class="col-xs-12 col-md-6">
                                        <div class="box">
                                            <!-- <iron-a11y-keys id="a11y" target="[[target]]" keys="enter" on-keys-pressed="onEnter"></iron-a11y-keys> -->
                                            <nylon-input id="license" label="เลขที่ใบอนุญาต" value="{{form.permit_number}}"></nylon-input>
                                        </div>
                                        <!-- <div class="size">
                                            <template is="dom-repeat" items="{{form.license}}">
                                                <paper-item class="border">
                                                    [[item]] <button on-click="deleteLicense">delete</button>
                                                </paper-item>
                                            </template>
                                        </div>  -->
                                    </div>
                                    <div class="col-xs-12 col-md-6">
                                        <div class="box">
                                            <vaadin-combo-box label="ประเภทข้าว" items="[[typeRice]]" value="{{form.type_rice_id}}" required></vaadin-combo-box>
                                        </div>
                                    </div>
                                    <div class="col-xs-12 col-md-6">
                                        <div class="box">
                                            <nylon-input label="ปริมาณการส่งออก" value="{{form.weight}}" format-number>
                                                <div suffix>ตัน</div>
                                            </nylon-input>
                                        </div>
                                    </div> 
                                    <div class="col-xs-12 col-md-6">
                                        <div class="box">
                                          <vaadin-date-picker label="วันที่รายงาน" value="{{form.report_date}}"></vaadin-date-picker>
                                        </div>
                                    </div>
                                    <div class="col-xs-12 col-md-6">
                                        <div class="box">
                                           <vaadin-date-picker label="วันที่ส่งออก" value="{{form.export_date}}"></vaadin-date-picker>
                                        </div>
                                    </div> 
                                    <div class="col-xs-12">
                                        <div class="box">
                                            <paper-textarea label="หมายเหตุ" value="{{form.note}}"></paper-textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </section>
                    </main>
                    <div class="row end-xs">
                        <div class="col-xs-6">
                            <div class="box section" style="text-align:right">
                                <paper-button on-tap="confirmDialog" raised class="gl-btn-success btn">บันทึก</paper-button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </template>
    <script>
        Polymer({
            is: 'exporter-report-form',
            behaviors: [ReduxBehavior, FormatNumberBehavior, MonthBehavior],
            observers:['searchExporter(word)','getTypeRice(form.year)'],
            properties: {
                external: {
                    statePath: 'exporterReport.external'
                },
                license:{
                    type:Array,
                    value:[]
                },
                form:{
                    statePath: 'exporterReport.form',
                    observer:'setItemExporter'
                },
                file: {
                    statePath: 'exporterReport.file'
                },
                listEu: {
                    type: Array,
                    value: [
                        {
                            id: 'true',
                            name: 'ในโควตา'
                        },
                        {
                            id: 'false',
                            name: 'นอกโควตา'
                        }
                    ]
                },
                checkDoc: {
                    type: Array,
                    value: [
                        {
                            id: 'c',
                            name: 'ถูกต้องตามประกาศ'
                        },
                        {
                            id: 'ic',
                            name: 'ไม่ถููกต้องตามประกาศ'
                        },
                        {
                            id: 'od',
                            name: 'เอกสารเกินกำหนด'
                        }
                    ]
                },
                typeRice: {
                    statePath: 'commonData.type_rice'
                },
                year: {
                    statePath: 'commonData.year'
                },
                company: {
                    statePath: 'commonData.companyReport',
                    observer:'clearLoad'
                },
                statusInvoid:{
                    type:Boolean
                }
            },
            getTypeRice:function(val){
                if(val)
                    this.dispatchAction('COMMON_DATA_GET_QUOTA_TYPE_RICE',val);
            },
            searchExporter:function(value){
                this.check = true;
                this.debounce('searchItem', () => {
                    // 
                    if (typeof value != 'undefined' && value.length >= 3) {
                        this.dispatchAction('COMMON_DATA_GET_COMPANY_REPORT', value);
                    }
                    else {
                        this.dispatchAction('COMMON_DATA_GET_COMPANY_CLEAR');
                    }

                }, 1000)
            },
            clearLoad:function(val){
                console.log(val)
                this.check = false;
            },
            setItemExporter:function(item){
                // console.log(item.id)
                if(item.id){
                    this.dispatchAction('COMMON_DATA_GET_COMPANY_REPORT', item.exporter_name);
                }
            },
            ready: function () {
                this.target = this.$.license;
            },
            onEnter: function (e) {
                if (this.target.value) {
                    if(typeof this.form.license == 'undefined') this.set('form.license',[]);
                    this.push('form.license', this.target.value);
                    this.dispatchAction('EXPORTER_REPORT_UPDATE_LICENSE_LIST',{data:this.form.license})
                    this.target.value = '';
                }
            },
            deleteLicense: function (e) {
                this.splice('form.license', e.model.index, 1)
                this.dispatchAction('EXPORTER_REPORT_UPDATE_LICENSE_LIST',{data:this.form.license})
            },
            checkPath: function (val) {
                if (val == '' || typeof val == 'undefined') {
                    return false
                }
                else {
                    return true
                }
            },
            getForm: function (val) {
                 this.dispatchAction('EXPORTER_REPORT_GET_EXTERNAL', val.currentTarget.value)
                 .then((res)=>{
                    if(Object.values(res).length > 0){
                        this.statusInvoid = true;
                        this.set('form.type_rice_id',res.type_rice_id);
                        this.set('form.weight',res.weight_ton);
                        this.set('form.exporter_name',res.company_name_th);
                        this.set('form.exporter_id',res.company_taxno);
                        this.searchExporter(res.company_taxno)
                    }
                 })
                  .catch((error) => {
                    this.statusInvoid = false;
                    // this.set('form.type_rice_id','');
                    // this.set('form.weight','');
                    // this.set('form.exporter_name','');
                    // this.set('form.exporter_id','');
                    console.log('error');
                    console.log(error);
                });
            },
            fileOpen: function () {
                // console.log(this.pathFile);
                window.open(this.file.path, '_blank');
            },
            confirmDialog:function(){
                this.fire('toast', {
                    status: 'openDialog',
                    text: 'ต้องการนำเข้าข้อมูลใช่ไหม ?',
                    confirmed: this.saveData.bind(this)
                })
            },
            saveData: function (check) {
                if(check == true){
                    if(this.form.quota == 'true') this.form.quota = true
                    else { this.form.quota = false}
                    this.form.weight = this.unFormat(this.form.weight);
                    // console.log(this.form);
                    // console.log('=w=')
                    if(this.form.id){
                        this.dispatchAction('EXPORTER_REPORT_UPDATE', this.form,this.select)
                    }
                }
                // else{
                //     var data = {
                //         form:getForm,
                //         files:this.$.uploadFile.fileList
                //     }
                //     console.log(data)
                //     this.dispatchAction('EXPORTER_REPORT_INSERT', data,this.select)
                // }
            }
        });
    </script>
</dom-module>