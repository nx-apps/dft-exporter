<link rel="import" href="../../../bower_components/vaadin-combo-box/vaadin-combo-box.html">
<link rel="import" href="../../layout/shared-styles.html">
<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../nylon-behavior.html">
<link rel="import" href="../components/nylon-panel-right.html">
<link rel="import" href="../components/page-header.html">
<link rel="import" href="../components/page-panel.html">
<link rel="import" href="../../redux-behavior.html">

<link rel="import" href="./components/period-list.html">

<link rel="import" href="../../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../components/ribbon-bar/ribbon-bar.html">
<link rel="import" href="../components/ribbon-tab/ribbon-tabs.html">
<link rel="import" href="../components/ribbon-tab/ribbon-tab.html">
<link rel="import" href="../components/sheet-tab/sheet-tabs.html">
<link rel="import" href="../components/sheet-tab/sheet-tab.html"> 
<dom-module id="page-period">
    <template>
        <style include="shared-styles">
            .icon {
                --iron-icon-height: 18px;
                --iron-icon-width: 18px;
                position: relative;
                left: 98%;
            }
        </style>

        <!-- <page-header label="ระบบยกยอดคงเหลือ">
        </page-header> -->

        <ribbon-tabs select="{{selectRibbon}}">
            <ribbon-tab name="home">ยกยอดคงเหลือ</ribbon-tab>
        </ribbon-tabs>

        <ribbon-bar width="{{w}}" height="{{h}}">
            <iron-collapse id="collapse">
                <page-panel>
                    <iron-icon class="icon" icon="close" on-tap="closeSearchBox"></iron-icon>
                    <div class="row around-xs">
                        <div class="col-xs-3">
                            <div class="box">
                                <vaadin-combo-box label="ปีโควตา" items="[[year]]" value="{{selectYear}}"></vaadin-combo-box>
                                <!--<vaadin-combo-box label="แสดงข้อมูลรายปี" items="[[year]]" value="{{selectYear}}"></vaadin-combo-box>-->
                            </div>
                        </div>
                        <div class="col-xs-3">
                            <div class="box">
                                <vaadin-combo-box label="ประเภทข้าว" items="[[typeRice]]" value="{{selectTypeRice}}">
                                </vaadin-combo-box>
                                <!--<vaadin-combo-box label="ประเภทข้าว" items="[[typeRice]]" item-label-path="type_rice_name_th" item-value-path="id" value="{{selectTypeRice}}"></vaadin-combo-box>-->
                            </div>
                        </div>
                        <div class="col-xs-3">
                            <div class="box">
                                <vaadin-combo-box label="งวดที่" items="[[period]]" item-label-path="period" item-value-path="period" value="{{selectPeriod}}">
                                    <template>
                                        [[item.period]]
                                    </template>
                                </vaadin-combo-box>
                                <!--<vaadin-combo-box label="ประเภทข้าว" items="[[typeRice]]" item-label-path="type_rice_name_th" item-value-path="id" value="{{selectTypeRice}}"></vaadin-combo-box>-->
                            </div>
                        </div>

                    </div>
                    <div class="section">
                        <div class="row center-xs">
                            <div class="col-xs-6">
                                <div class="box">
                                    <paper-button class="gl-btn-primary" on-tap="searchData" style="width:100%">
                                        <iron-icon icon="search" raised></iron-icon>
                                        ค้้นหา</paper-button>
                                </div>
                            </div>
                        </div>
                    </div>
                </page-panel>
                <div class="row end-xs">
                    <div class="col-xs-6">
                        <div class="box" style="text-align:right">
                            
                            <template is="dom-if" if="{{checkPeroid(selectPeriod)}}">
                                <paper-button class="gl-btn-primary" on-tap="confirmClosePeriod" raised>
                                    <iron-icon icon="check"></iron-icon>
                                    ปิดงวด
                                </paper-button>
                            </template>
                        </div>
                    </div>
                </div>
            </iron-collapse>
        </ribbon-bar>

        <div class="section">
            <period-list height="[[h]]" year="{{selectYear}}" type-rice="{{selectTypeRice}}"></period-list>
        </div>

        <!-- <nylon-panel-right title="กำหนดปีโควตา" width="90%">
        <quota-manage select-year="{{selectYear}}"></quota-manage>
      </nylon-panel-right>
       -->
    </template>
    <script>
        Polymer({
            is: 'page-period',
            behaviors: [NylonBehavior, ReduxBehavior],
            listeners: {
                'open-panel': 'openPanel'
            },
            observers: ['getPeriod(selectYear,selectTypeRice)','setYear(selectYear)'],
            properties: {
                year: {
                    statePath: 'commonData.year',
                },
                typeRice: {
                    statePath: 'commonData.type_rice'
                },
                period: {
                    statePath: 'period.period'
                },
                selectRibbon: {
                    type: String,
                    value: 'home',
                    observer: '_selectRibbonChanged'
                }
            },
            nylonPageActive: function () {
                // this.dispatchAction('QUOTA_SET_ELEMENT');
                this.dispatchAction('COMMON_DATA_GET_YEAR')
                // this.dispatchAction('COMMON_DATA_GET_TYPE_RICE');
            },
            setYear:function(val){
                if(val){
                     this.dispatchAction('COMMON_DATA_SET_YEAR',val)
                }
            },
            getPeriod: function (year, type_rice) {
                if (year != "" && type_rice != "") {
                    //console.log(year,type_rice)
                    this.dispatchAction('PERIOD_GET_LIST', year, type_rice)
                }

            },
            checkPeroid:function(val){
                if(val == 'แสดงทั้งหมด' || val == 4) return false
                else return true
            },
            searchData: function () {
                if (this.selectYear != "" && this.selectTypeRice != "" && this.selectPeriod != "") {
                    var newItem = {
                        year : this.selectYear,
                        type_rice : this.selectTypeRice,
                        period : this.selectPeriod
                    }
                    this.dispatchAction('PERIOD_CLEAR_LIST');
                    if(this.selectPeriod == "แสดงทั้งหมด") {
                        this.dispatchAction('PERIOD_GET_QUOTA_EC_ALL', newItem.year, newItem.type_rice)
                    }
                    else{
                        this.dispatchAction('PERIOD_GET_QUOTA_EC', newItem.year, newItem.type_rice, newItem.period)
                    }
                    this.selectRibbon = "none"
                }
            },
            confirmClosePeriod: function () {
                this.fire('toast', {
                    status: 'openDialog',
                    text: 'ต้องการปิดงวดใช่หรือไม่ ?',
                    confirmed: this.closePeriod.bind(this)
                })
            },
            closePeriod:function(check){
                if(check){
                    this.dispatchAction('PERIOD_CLOSE_PERIOD',this.selectYear,this.selectTypeRice,this.selectPeriod)
                }
            },
            _selectRibbonChanged: function (val) {
                if (val !== "none") {
                this.$.collapse.opened = true;
                } else {
                this.$.collapse.hide();
                }
            },
            closeSearchBox: function () {
                this.selectRibbon = "none"
            }

        });
    </script>
</dom-module>