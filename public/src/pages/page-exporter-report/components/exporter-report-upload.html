<link rel="import" href="./../../../../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="./../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="./../../../../bower_components/iron-icons/image-icons.html">
<link rel="import" href="../../../../bower_components/paper-progress/paper-progress.html">
<link rel="import" href="./../../../layout/shared-styles.html">
<link rel="import" href="./../../../redux-behavior.html">
<link rel="import" href="./../../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="./../../../../bower_components/paper-icon-button/paper-icon-button.html">


<dom-module id="exporter-report-upload">
    <template>
        <style include="shared-styles">
            paper-button{
                width: 100%;
                margin: 0px;
            }
        </style>
        <div class="row center-xs">
            <div class="col-xs-12">
                <div class="box">
                    <paper-button on-tap="uploadFile" raised>
                        <iron-icon icon="get-app"></iron-icon>
                        upload
                    </paper-button>
                    <input type="file" on-change="changeFile" id="file" hidden multiple accept="application/pdf">
                    <!-- <button on-click="onfirmUpload">ยืนยัน</button> -->
                </div>
            </div>
        </div>
        <vaadin-grid id="material" items="[[data]]" size="200">
            <vaadin-grid-column flex-grow="0">
                <template class="header">
                    <div class="cell" style="text-align:center;padding:15px">
                        #
                    </div>
                </template>
                <template>
                    <div class="cell" style="text-align:center;padding:15px">
                        [[count(index)]]
                    </div>
                </template>
            </vaadin-grid-column>
            <vaadin-grid-column width="300px">
                <template class="header">
                    <div class="cell">
                        ชื่อไฟล์
                    </div>
                </template>
                <template>
                    <div class="cell">
                        [[item.name]]
                    </div>
                </template>
            </vaadin-grid-column>
            <vaadin-grid-column>
                <template class="header" flex-grow="0">
                    <div class="cell">
                        จัดการ
                    </div>
                </template>
                <template>
                    <div class="cell">
                        <paper-icon-button on-tap="selectFile" icon="image:picture-as-pdf"></paper-icon-button>
                        <paper-icon-button on-tap="confirmDelete" icon="delete"></paper-icon-button>
                    </div>
                </template>
            </vaadin-grid-column>
        </vaadin-grid>

        <paper-toast id="toast" text="upload..." duration="0" no-cancel-on-esc-key>
            <paper-progress class="blue" indeterminate></paper-progress>
        </paper-toast>
    </template>
    <script>
        Polymer({
            is: 'exporter-report-upload',
            behaviors: [ReduxBehavior],
            properties:{
                data:{
                   statePath:'exporterReport.listUpload'
                },
                select:{
                    type:String,
                    value:''
                },
                files:{
                    type:Array,
                    value:[]
                },
                fileList:{
                    type:Array,
                    value:[]
                }
            },
            count:function(val){
                return val+1;
            },
            confirmDelete:function(e){
                this.fire('toast',{ 
                 status:'openDialog',
                 text:'ต้องการลบข้อมูลใช่หรือไม่ ?',
                 confirmed:this.deleteFile.bind(this),
                 data: e.model.item.file_id
                 })
            },
            deleteFile:function(check,data){
                // console.log(e.model.item.file_id);
                if(check == true){
                    console.log(check)
                    this.dispatchAction('EXPORTER_REPORT_DELETE_FILE',data)
                    .then((response)=>{
                        this.dispatchAction('EXPORTER_REPORT_LIST_UPLOAD',this.select.id);
                    })
                    .catch((error)=>{
                        console.log('error');
                        console.log(error);
                    });
                }
            },
            uploadFile: function () {
                this.$.file.click();
            },
            selectFile:function(e){
                // console.log(e.model.item.file_id);
                if(e.model.item.file_id) 
                    this.dispatchAction('EXPORTER_REPORT_SELECT_FILE',e.model.item)
                    // this.fire('show-file',e.model.item)
                // this.dispatchAction('EXPORTER_REPORT_LIST_UPLOAD_SELECT',e.model.item.file_id);
            },
            changeFile: function (e) {
                console.log(e.currentTarget.files,this.select)
                if(e.currentTarget.files.length != 0){
                    this.$.toast.open();
                    this.fire('toast',{status:'load'});
                    this.dispatchAction('EXPORTER_REPORT_UPLOAD_REPORT', e.currentTarget.files,this.select)
                        .then(function (res) {
                            this.fire('toast',{status:'success',text:'บันทึกสำเร็จ',
                            callback:function(){
                            }
                            });
                            console.log(this.select.id)
                            this.dispatchAction('EXPORTER_REPORT_LIST_UPLOAD',this.select.exporter_id);
                        }.bind(this))
                    this.$.toast.close();
                }
               
            }
        });
    </script>
</dom-module>