<!-- <link rel="import" href="components/member-page.html"> -->
<link rel="import" href="./../../../bower_components/polymer/polymer.html">
<link rel="import" href="../components/panel-right/panel-right.html">
<link rel="import" href="../../nylon-behavior.html">
<link rel="import" href="./../../../bower_components/gl-grid/gl-grid-col.html">
<link rel="import" href="./../../../bower_components/gl-grid/gl-grid-row.html">
<link rel="import" href="./../../../bower_components/paper-material/paper-material.html">
<link rel="import" href="./../../../bower_components/gl-form/gl-combo-box.html">
<link rel="import" href="./../../../bower_components/gl-form/gl-form-dropdown-menu.html">
<link rel="import" href="./../../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="./../../../bower_components/paper-item/paper-item.html">
<link rel="import" href="./../../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="./../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="./../../../bower_components/gl-styles/gl-size.html">
<link rel="import" href="./../../../bower_components/gl-styles/gl-color.html">
<link rel="import" href="./../../../bower_components/gl-styles/gl-table.html">
<link rel="import" href="./../../../bower_components/gl-styles/gl-panel.html">
<link rel="import" href="./../../../bower_components/gl-styles/gl-toast.html">
<link rel="import" href="./../../layout/nylon-toast.html">
<link rel="import" href="../components/validateFormBehaviors.html">
<link rel="import" href="../../../bower_components/vaadin-combo-box/vaadin-combo-box.html">
<link rel="import" href="./../components/nylon-datepicker.html">
<link rel="import" href="../../redux-behavior.html">
<link rel="import" href="../../nylon-behavior.html">
<link rel="import" href="../../i18n-behavior.html">
<link rel="import" href="./../components/month-behavior.html">
<link rel="import" href="../../action/uploadAction.html">
<link rel="import" href="../../action/exporterAction.html">
<link rel="import" href="../../layout/page-style.html">
<link rel="import" href="../../i18n-behavior.html">
<link rel="import" href="../../action/confirmAction.html">

<link rel="import" href="../../../bower_components/gl-form/gl-form-panel.html">

<link rel="import" href="./components/list-file-delete.html">

<link rel="import" href="../page-draft/components/detail-company.html">
<link rel="import" href="../../action/settingAction.html">
<link rel="import" href="../page-draft/components/fileup-company.html">

<dom-module id="page-admin-exporter">
  <style is="custom-style" include="page-style iron-flex iron-flex-factors iron-flex-alignment gl-size gl-color gl-table gl-toast">
    * {
      font-family: 'CSChatThaiUI', sans-serif !important;
      -webkit-font-smoothing: antialiased;
    }

    .bg-title {
      --vaadin-date-picker-overlay: {
        color: red;
      }
    }

    .title {
      text-align: center;
      font-size: var(--font-size-h3);
    }

    .text-table {
      text-align: center;
      font-size: var(--font-size-h5);
    }

    .searchBox {
      padding: 5px;
      background-color: var(--gl-gray-lighter-color);
    }

    .elevation {
      border-radius: 5px;
      margin: 10px;
      padding: 5px;
    }

    .searchBorder {
      border: 1px solid var(--gl-gray-light-color);
      margin: 15px;
      border-radius: 3px;
    }

    .gl-table-default {
      border-collapse: collapse;
      width: 100%;
      white-space: nowrap;
    }

    paper-material {
      background-color: var(--gl-white-color);
    }

    main {
      padding: 5px;
      margin: 0 auto;
    }

    section {
      display: none;
      border-top: 1px solid #ddd;
    }

    input {
      display: none;
    }

    label {
      display: inline-block;
      margin: 0 0 -1px;
      padding: 15px 25px;
      font-weight: 600;
      text-align: center;
      color: #bbb;
      border: 1px solid transparent;
      background: #D5D8DC;
    }

    label:before {
      font-family: fontawesome;
      font-weight: normal;
      margin-right: 10px;
    }

    label:hover {
      color: #888;
      cursor: pointer;
    }

    input:checked+label {
      color: #555;
      border: 1px solid #ddd;
      border-top: 3px solid orange;
      border-bottom: 1px solid #fff;
      background: #fff;
    }

    #tab1:checked~#content1,
    #tab2:checked~#content2,
    #tab3:checked~#content3 {
      display: block;
    }

    detail-company,
    fileup-company,
    list-file-delete {
      margin-top: 15px;
      width: 98%;
    }

    .container {
      display: inline-block;
      margin-left: 30px;
      margin-right: 30px;
    }

    table.gl-table-default>tbody.table-body>tr>td {
      /*cursor: pointer;*/
      padding: 10px 15px;
    }
  </style>
  <template>
    <paper-material elevation="1" class="elevation">
      <div class="layout vertical" style="margin: 20px 20px 10px 20px;">

        <div class="flex title">
          {{localize.title_exporter}}
        </div>


        <div class="searchBox searchBorder">
          <div class="horizontal start-justified layout">
            <div class="flex-3"></div>
            <div class="flex-6 flex-padding">
              {{searchInput(dataSearch)}}
              <vaadin-combo-box label="{{localize.name_exporter}}" items="{{list_search}}" item-label-path="company_name" item-value-path="id"
                value="{{dataSelected.id}}" on-value-changed="_checkID" loading={{checkLoad}} filter={{dataSearch}}>
                <template>[[item.company_name]]</template>
              </vaadin-combo-box>
            </div>
            <div class="flex-3"></div>
          </div>

          <div class="horizontal start-justified layout">
            <div class="flex-3"></div>
            <div class="flex-2 flex-padding">
              <gl-form-dropdown-menu class="searchForm" label="{{localize.type_license}}" placeholder="{{localize.all}}">
                <paper-menu class="dropdown-content" attr-for-selected="value" selected="{{dataSelected.lic_type_id}}" name="lic_type_id">
                  <paper-item>{{localize.all}}</paper-item>
                  <template is="dom-repeat" items={{licType}}>
                    <paper-item value="[[item.id]]">{{item.lic_type_name}}</paper-item>
                  </template>
                </paper-menu>
              </gl-form-dropdown-menu>
            </div>
            <div class="flex-2 flex-padding">
              <gl-form-dropdown-menu class="searchForm" label="{{localize.status_export}}" placeholder="{{localize.all}}">
                <paper-menu class="dropdown-content" attr-for-selected="value" selected="{{dataSelected.exporter_status}}" name="exporter_status">
                  <paper-item>{{localize.all}}</paper-item>
                  <paper-item value="true">{{localize.member}}</paper-item>
                  <paper-item value="false">{{localize.no_member}}</paper-item>
                </paper-menu>
              </gl-form-dropdown-menu>
            </div>
            <div class="flex-2 flex-padding">
              <gl-form-dropdown-menu class="searchForm" label="{{localize.status_exporter}}" placeholder="{{localize.all}}">
                <paper-menu class="dropdown-content" attr-for-selected="value" selected="{{dataSelected.export_status}}" name="exporter_active">
                  <paper-item>{{localize.all}}</paper-item>
                  <paper-item value="true">{{localize.normally}}</paper-item>
                  <paper-item value="false">{{localize.expire}}</paper-item>
                </paper-menu>
              </gl-form-dropdown-menu>
            </div>
            <div class="flex-3"></div>
          </div>

          <div class="horizontal start-justified layout">
            <div class="flex-2"></div>
            <div class="flex flex-padding" style="margin-top:18px; text-align:right;">{{localize.register}}</div>
            <div class="flex-3 flex-padding">
              <nylon-datepicker value="[[dataSelected.date_start]]" value-return="{{dataSelected.date_start}}">
              </nylon-datepicker>
            </div>
            <div class="flex-padding" style="margin-top:18px; text-align:right;">{{localize.to}}</div>
            <div class="flex-3 flex-padding">
              <nylon-datepicker value="[[dataSelected.date_end]]" value-return="{{dataSelected.date_end}}">
              </nylon-datepicker>
            </div>
            <div class="flex-2"></div>
          </div>

          <div class="horizontal layout center-justified">
            <!--<div class="flex">ๅๅๅ-->
            <paper-button class="gl-btn-info" style="margin: 30px 0px 10px 50px;" on-tap="_search" title="{{localize.bt_search}}" raised>{{localize.bt_search}}</paper-button>
            <!--</div>-->
          </div>
        </div>

        <div class="horizontal layout end-justified">
          <div style="margin:30px 10px 0px 20px;">
            <iron-icon icon="print"></iron-icon>
          </div>
          <gl-form-dropdown-menu style="width:250px; margin-right:20px;" placeholder="{{localize.select_report}}" name="report">
            <paper-menu class="dropdown-content" attr-for-selected="report" selected="{{report}}">
              <paper-item on-tap="_report" report="report1">{{localize.report1}}</paper-item>
              <paper-item on-tap="_report" report="report2">{{localize.report2}}</paper-item>
              <paper-item on-tap="_report" report="report3">{{localize.report3}}</paper-item>
            </paper-menu>
          </gl-form-dropdown-menu>
        </div>

        <div class="searchBorder" style="height:600px; overflow-x:auto; overflow-y:auto;">
          <table class="gl-table-default">
            <thead class="table-head">
              <tr>
                <th>
                  <div class="text-table">#</div>
                </th>
                <th>
                  <div class="text-table">{{localize.no_exporter}}</div>
                </th>
                <!--<th>
                  <div class="text-table">{{localize.no_tax}}</div>
                </th>-->
                <th>
                  <div class="text-table">{{localize.name_company}}</div>
                </th>
                <th>
                  <div class="text-table">{{localize.type_license}}</div>
                </th>
                <!--<th>
                  <div class="text-table">{{localize.status_export}}</div>
                </th>-->
                <th>
                  <div class="text-table">{{localize.status_exporter}}</div>
                </th>
                <th>
                  <div class="text-table">{{localize.date_load}}</div>
                </th>
                <th>
                  <div class="text-table">{{localize.date_expire}}</div>
                </th>
              </tr>
            </thead>

            <template is="dom-repeat" items="{{exporters}}">
              <tbody>
                <tr id="detailRegExporter" on-tap="_selectData" data="[[item]]" style="cursor:pointer;">
                  <td>
                    <div class="text-table">[[toIndex(index)]]</div>
                  </td>
                  <td>
                    <div class="text-table">{{item.lic_type.lic_type_prefix}} {{item.exporter_no}}</div>
                  </td>
                  <!--<td>
                    <div class="text-table">{{item.company_taxno}}</div>
                  </td>-->
                  <td>
                    <div>{{item.company.company_name_th}}</div>
                  </td>
                  <td>
                    <div>{{item.lic_type.lic_type_name}}</div>
                  </td>
                  <!--<td>
                    <div class="text-table">{{item.exporter_status_name}}</div>
                  </td>-->
                  <td>
                    <div class="text-table">{{exprieDate(item.export_status)}}</div>
                  </td>
                  <td>
                    <div class="text-table">{{changeDate(item.date_load)}}</div>
                  </td>
                  <td>
                    <div class="text-table">{{changeDate(item.date_expire)}}</div>
                  </td>
                </tr>
            </template>

            <template is="dom-if" if={{_checkData(exporters)}}>
              <tr>
                <td colspan="8">
                  <div class="text-table" style="margin:20px">{{localize.not_found}}</div>
                </td>
              </tr>
            </template>
            </tbody>
          </table>
        </div>
      </div>

      <div class="horizontal justified layout" style="margin:0px 40px 10px 40px;">
        <div>
          {{localize.company}}{{localize.all}} [[countExporters(exporters)]] {{localize.company}}
        </div>
        <div>
          {{localize.page}}
          <select id="selectedPage" on-change="selectPage">
              <template is="dom-repeat" items={{pages}}>
                  <option value="{{item}}">{{item}}</option>
              </template>
          </select> / [[countPage(pages)]] {{localize.page}}
        </div>
      </div>

    </paper-material>

    <panel-right title="{{titleName}}">
      <div class="left">
        <main>
          <input id="tab1" type="radio" name="tabs" checked>
          <label for="tab1">
                <div class="container" tabindex="0">
                  <span>1.{{localize.detail}}</span>
                </div>
              </label>

          <input id="tab2" type="radio" name="tabs">
          <label for="tab2">
              <div class="container" tabindex="0">
                <span>2.{{localize.doc_ev}}</span>
                </div>
              </label>

          <input id="tab3" type="radio" name="tabs">
          <label for="tab3">
                  <div class="container" tabindex="0">
                    <span>3.เอกสารที่ถูกลบ</span>
                    </div>
                  </label>


          <section id="content1">
            <gl-form-panel>
              <detail-company id="detailCompany" data={{resultCompany}}></detail-company>
              <table class="gl-table-default" style="width: 100%;border: 1px solid #ddd; margin: 20px 0px 10px 0px;">
                <thead class="table-head">
                  <tr>
                    <th style="width :20%">ลำดับที่</th>
                    <th style="width :30%">สถานะการดำเนินงาน</th>
                    <th style="width : 30%">วันที่</th>
                  </tr>
                </thead>
                <tbody class="table-body">
                  <template is="dom-repeat" items="{{resultCompany.remark}}">
                    <tr>
                      <td>[[indexNo(index)]]</td>
                      <td>[[item.msg]]</td>
                      <td>[[changeDate(item.date)]]</td>
                    </tr>
                  </template>

                  <template is="dom-if" if={{checkArrayEmpty(resultCompany.remark)}}>
                    <tr>
                      <td colspan=3 style="text-align:center">ไม่มีข้อมูล</td>
                    </tr>
                  </template>
                </tbody>
              </table>
            </gl-form-panel>
          </section>

          <section id="content2">
            <gl-form-panel>
              <fileup-company company-taxno="{{resultCompany.company_taxno}}" draft-id="{{resultCompany.draft_id}}" ></fileup-company>
            </gl-form-panel>
          </section>
          <section id="content3">
            <gl-form-panel>
              <list-file-delete draft-byid="{{draftById}}"></list-file-delete>
            </gl-form-panel>
          </section>


        </main>
      </div>
    </panel-right>

  </template>
  <script>
    Polymer({
      is: "page-admin-exporter",
      behaviors: [ReduxBehavior, nylonBehavior, settingAction, i18nAction, confirmAction, exporterAction, uploadAction, ValidateFormBehavior, MonthBehavior],
      properties: {
        layerContent: {
          type: String,
          value: "detailRegExporter"
        },
        dataSelected: {
          type: Object,
          value: {}
        },
        localize: {
          statePath: 'i18n.exporter'
        },
        exporters: {
          statePath: 'exporter.list'
        },
        list_search: {
          statePath: 'exporter.list_search',
          observer: 'checkDataSearch'
        },
        licType: {
          statePath: 'setting.listLictype'
        },
        pages: {
          statePath: 'exporter.pages'
        },
        draftById: {
          statePath: 'exporter.data',
          observer: 'setExporter'
        },
        resultCompany: {
          type: Object,
          value: {}
        },
        listFiles: {
          statePath: 'upload.fileList',
          observer: 'checkFile'
        }
      },
      checkFile(file) {
        let data = this.draftById
        if (data !== undefined) {
          let urlFalse = {
            draft_status: data.draft_status,
            company_taxno: data.company_taxno,
            draft_id: data.draft_id,
            file_status: false,
          }
          let newurlFalse = this.genUrl(urlFalse) + `file_status=false`
          this.dispatchAction('UPLOAD_GET_LIST_DELETE', newurlFalse)
        }

      },
      nylonPageActive: function () {
        this.dispatchAction('EXPORTER_GET_DATA');
        // this.dispatchAction('EXPORTER_GET_DATA_SEARCH');
        this.dispatchAction('SETTING_GET_LIST_LIC');
        this.dispatchAction('EXPORTER_GET_PAGE');
        this.dispatchAction('EXPORTER_GET_DOC_TYPE');
      },
      setExporter: function (data) {
        if (data.hasOwnProperty('draft_id')) {

          let url = {
            draft_id: data.draft_id,
            file_status: true,
            draft_status: data.draft_status,
            company_taxno: data.company_taxno
          }
          this.dispatchAction('UPLOAD_GET_LIST', this.genUrl(url))
          let urlFalse = {
            draft_status: data.draft_status,
            company_taxno: data.company_taxno,
            draft_id: data.draft_id,
            file_status: false,
          }
          let newurlFalse = this.genUrl(urlFalse) + `file_status=false`
          // console.log(newurlFalse);
          this.dispatchAction('UPLOAD_GET_LIST_DELETE', newurlFalse)
          this.set('resultCompany', data)
          this.dispatchAction('CONFIRM_TYPE', 'registerdraft')
          this.fire('toast', {
            status: 'success', text: 'โหลดข้อมูลสำเร็จ', callback: () => {
              this.$$('panel-right').open();
            }
          })

        }
      },
      indexNo: function (val) {
        return val + 1
      },
      changeDate(date) {
        let time = new Date(date)
        date = new Date(time.setHours(time.getHours() + 7)).toISOString()
        date = date.split("T")[0]
        return date
      },
      attached() {
        let date = new Object()
        let today = new Date(new Date().setFullYear(new Date().getFullYear()))
        ////console.log(today);
        let month = today.getMonth() + 1
        if (month < 10)
          month = '0' + month
        dateStart = today.getFullYear() + 543 + '-' + month + "-" + today.getDate()
        let nextDay = dateEnd = new Date(today.setDate(today.getDate() + 7)).toISOString().split('T')[0]
        // console.log(nextDay.split('-')[2]);
        dateEnd = today.getFullYear() + 543 + '-' + month + "-" + nextDay.split('-')[2]
        // console.log(dateStart);
        // console.log(dateEnd);
        this.set('dataSelected.date_start', dateStart)
        this.set('dataSelected.date_end', dateEnd)
      },
      exprieDate(date) {
        if (date) {
          return 'ยังไม่หมดอายุ'
        }
        return 'หมดอายุ'
      },
      searchInput: function (val) {
        this.checkLoad = true;
        let reg_num = new RegExp('[0-9]');
        let reg_char_th = new RegExp('[ก-๙]');
        let reg_char_en = new RegExp('[a-zA-Z]');

        this.debounce('searchInput', () => {
          if (typeof val !== 'undefined' && val.length >= 3) {
            if (reg_num.test(val) === true) {
              this.dispatchAction('EXPORTER_GET_DATA_SEARCH', { att_name: 'company_taxno', val: val, type: 'number' });
            } else if (reg_char_th.test(val) === true) {
              this.dispatchAction('EXPORTER_GET_DATA_SEARCH', { att_name: 'company_name_th', val: val, type: 'char_th' });
            } else if (reg_char_en.test(val) === true) {
              this.dispatchAction('EXPORTER_GET_DATA_SEARCH', { att_name: 'company_name_en', val: val, type: 'char_en' });
            }
          } else {
            // console.log('clear');
            this.dispatchAction('EXPORTER_CLEAR_LIST_SEARCH');
          }
        }, 500)
      },
      checkDataSearch(val) {
        this.checkLoad = false;
      },
      _selectData: function (e) {
        let newUrl = {
          id: e.currentTarget.data.id
        }
        this.fire('toast', { status: 'load', text: 'กำลังดึงข้อมูล...' })
        this.dispatchAction('EXPORTER_GET_DATA_ID', this.genUrl(newUrl));
        this.layerContent = "detailRegExporter";
        this.titleName = 'ข้อมูลผู้ส่งออก';
      },
      _checkID: function (id) {
        if (id.detail.value !== "" && typeof id.detail.value !== 'undefined') {
          var id = id.detail.value;
          let newUrl = {
            id: id
          }
          // --------------------------------------------------------------------
          this.fire('toast', { status: 'load', text: 'กำลังดึงข้อมูล...' })
          this.dispatchAction('EXPORTER_GET_DATA_ID', this.genUrl(newUrl));
          // this.dispatchAction('EXPORTER_GET_LIC_TYPE');
          this.dispatchAction('EXPORTER_GET_DOC_TYPE');
          this.layerContent = "detailRegExporter";
          this.titleName = 'ข้อมูลผู้ส่งออก';
          var searchId = this.list_search.filter((item) => {
            return item.id == id
          })

        }
      },
      genUrl(url) {
        let data = new String()
        let url_length = Object.getOwnPropertyNames(url).length
        let count = new Number()
        // //console.log(url);
        for (var variable in url) {
          if (url[variable] != '') {
            data = data + variable + "=" + url[variable];
            (count < url_length - 1) ? data += '&' : '';
          }
          count++
        }
        // //console.log(data);
        return data
      },
      _search: function (type) {
        // this.fire('toast', { status: 'load' })
        // console.log(this.dataSelected);
        var page = this.$$('#selectedPage').value;
        var str = '';

        if (this.dataSelected.date_start != undefined && this.dataSelected.date_start != '' && (this.dataSelected.date_end == undefined || this.dataSelected.date_end == '')) {
          this.fire('toast', { status: 'connectError', text: 'กรุณาใส่วันที่สิ้นสุดค้นหา' })
        }
        else if (this.dataSelected.date_end != undefined && this.dataSelected.date_end != '' && (this.dataSelected.date_start == undefined || this.dataSelected.date_start == '')) {
          this.fire('toast', { status: 'connectError', text: 'กรุณาใส่วันที่เริ่มต้นค้นหา' })
        } else {
          // console.log(this.dataSelected.lic_type_id === null);
          str = this._retiveData()

          // console.log(str);
          // for (key in this.dataSelected) {
          //   if (this.dataSelected[key] != '' && this.dataSelected[key] != null) {
          //     if (str == '') { str += '?' } else { str += '&' }
          //     str += key + '=' + this.dataSelected[key];
          //     // str += '&' + key + '=' + this.dataSelected[key];
          //   }
          // }
          // console.log(121212);
          this.dispatchAction('EXPORTER_SEARCH', str, page, type);
          // console.log(this.queryFrom('.searchForm'));
          this.queryFrom('.searchForm').map((el) => el.reset());
          return str;
        }
      },
      _retiveData() {
        let str = ''
        if (this.dataSelected.lic_type_id === null) {
          this.dataSelected.lic_type_id = 'all'
        }
        if (this.dataSelected.exporter_status === null) {
          delete this.dataSelected.exporter_status
        }
        if (this.dataSelected.export_status === null) {
          delete this.dataSelected.export_status
        }
        if (this.dataSelected.date_start !== '' & this.dataSelected.date_end != '') {
          let date = JSON.parse(JSON.stringify(this.dataSelected));
          date.date_start = (Number(date.date_start.split('-')[0]) - 543) + '-' + date.date_start.split('-')[1] + '-' + date.date_start.split('-')[2]
          date.date_end = (Number(date.date_end.split('-')[0]) - 543) + '-' + date.date_end.split('-')[1] + '-' + date.date_end.split('-')[2]
          // console.log(date)
          str = this.genUrl(date)
        }
        return str
      },
      _report: function (e) {
        var str = this._retiveData();
        // console.log(str);
        window.open('./api/external/report_exporter/' + e.target.getAttribute('report') + (str != '' ? '?' + str : ''), '_blank');
      },
      _checkData: function (val) {
        if (val.length > 0) {
          return false
        }
        else {
          return true
        }
      },
      toIndex: function (index) {
        return index + 1;
      },
      selectPage: function () {
        var page = this.$$('#selectedPage').value;
        this.dispatchAction('EXPORTER_GET_DATA', page);
      },
      countPage: function (page) {
        return page.length
      },
      countExporters: function (val) {
        return numeral(val.length).format('0,0');
      }
    });
  </script>
</dom-module>