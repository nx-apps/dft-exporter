<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../layout/shared-styles.html">
<link rel="import" href="../../nylon-behavior.html">
<link rel="import" href="../components/page-header.html">
<link rel="import" href="../components/page-panel.html">
<link rel="import" href="../../../bower_components/vaadin-combo-box/vaadin-combo-box.html">
<link rel="import" href="../components/nylon-panel-right.html">
<link rel="import" href="../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="./components/confirm-list.html">
<link rel="import" href="./components/confirm-manage.html">
<link rel="import" href="../../redux-behavior.html">
<link rel="import" href="../components/format-number-behavior.html">

<link rel="import" href="../../../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../components/ribbon-bar/ribbon-bar.html">
<link rel="import" href="../components/ribbon-tab/ribbon-tabs.html">
<link rel="import" href="../components/ribbon-tab/ribbon-tab.html">

<link rel="import" href="../components/sheet-tab/sheet-tabs.html">
<link rel="import" href="../components/sheet-tab/sheet-tab.html">
<link rel="import" href="../components/offset-value/offset-value.html">
<link rel="import" href="../../../bower_components/iron-pages/iron-pages.html">


<dom-module id="page-confirm">
    <template>
        <style include="shared-styles">
            .icon {
                --iron-icon-height: 18px;
                --iron-icon-width: 18px;
                position: relative;
                left: 98%;
            }
        </style>

        <ribbon-tabs select="{{selectRibbon}}">
            <ribbon-tab name="home">ยืนยันรับส่วนจัดสรร</ribbon-tab>
        </ribbon-tabs>

        <ribbon-bar height="{{h}}">
            <iron-collapse id="collapse">
                <page-panel>
                    <iron-icon class="icon" icon="close" on-tap="closeSearchBox"></iron-icon>
                    <div class="row around-xs">
                        <div class="col-xs-3">
                            <div class="box">
                                <vaadin-combo-box label="แสดงข้อมูลรายปี" items="[[year]]" value="{{selectYear}}">
                                    <template>
                                        [[item.label]]
                                    </template>
                                </vaadin-combo-box>
                            </div>
                        </div>
                        <div class="col-xs-3">
                            <div class="box">
                                <vaadin-combo-box label="ประเภทข้าว" items="[[typeRice]]" value="{{data.typeRice}}">
                                    <template>
                                        [[item.label]]
                                    </template>
                                </vaadin-combo-box>
                            </div>
                        </div>
                        <div class="col-xs-3">
                            <div class="box">
                                <vaadin-combo-box label="การคำนวณครั้งที่่" items="[[ordinal]]" value="{{data.ordinal}}">
                                    <template>
                                        [[item]]
                                    </template>
                                </vaadin-combo-box>
                            </div>
                        </div>
                    </div>

                    <div class="section">
                        <div class="row center-xs">
                            <div class="col-xs-6">
                                <div class="box">
                                    <paper-button class="gl-btn-primary" on-tap="searchData" style="width:100%">
                                        <iron-icon icon="search" raised></iron-icon>
                                        ค้้นหา</paper-button>
                                </div>
                            </div>
                        </div>
                    </div>

                </page-panel>
            </iron-collapse>
        </ribbon-bar>
        <offset-value height="{{offH}}">
            <iron-pages attr-for-selected="name" selected="[[selected]]">
                <div name="noneConfirm">
                    <div class="row end-xs">
                        <div class="col-xs-6">
                            <div class="box" style="text-align:left;font-size:1.2rem;">
                                ปริมาณคงเหลือที่ยังไม่ยืนยัน {{formatNumber(list.noconfirm.amount)}} ตัน
                            </div>
                        </div>
                        <div class="col-xs-6">
                            <div class="box" style="text-align:right">
                                <template is="dom-if" if={{checkStatus(list.noconfirm.status)}}>
                                    <paper-button class="gl-btn-danger" id="cancelperiod" on-tap="confirmDialog" hidden="[[list.state.confirm]]" raised>
                                        ไม่รับส่วนจัดสรร
                                    </paper-button>
                                    <paper-button class="gl-btn-primary" id="addperiod" on-tap="confirmDialog" hidden="[[list.state.confirm]]" raised>
                                        ยืนยันส่วนจัดสรร
                                    </paper-button>
                                </template>
                            </div>
                        </div>
                    </div>
                </div>
                <div name="confirmed">
                    <div class="row end-xs">
                        <div class="col-xs-6">
                            <div class="box" style="text-align:left;font-size:1.2rem;">
                                ปริมาณที่ยืนยัน {{formatNumber(list.confirm.amount)}} ตัน
                            </div>
                        </div>
                        <div class="col-xs-6">
                            <div class="box" style="text-align:right">
                                <!-- <template is="dom-if" if={{!checkStatus(list.noconfirm.status)}}>
                                    <paper-button class="gl-btn-primary" on-tap="confirmSendToEDI" raised>ส่งยอด EDI</paper-button>
                                </template> -->
                                <template is="dom-if" if={{checkStatus(list.noconfirm.status)}}>
                                    <paper-button class="gl-btn-primary" id="confirmList" on-tap="confirmList" hidden="[[list.state.confirm]]" raised>ยืนยันการทำรายการ</paper-button>
                                    <paper-button class="gl-btn-primary" id="unConfirm" on-tap="confirmDialog" hidden="[[list.state.confirm]]" raised>คืนส่วนจัดสรร</paper-button>

                                    <!-- <paper-button on-tap="confirmExporter" class="gl-btn-primary" raised>ส่งยอด EDI</paper-button> -->
                                    <!-- <paper-button on-tap="clearperiod" class="gl-btn-danger" raised>
                                        ยกเลิกส่วนจัดสรร
                                    </paper-button> -->
                                </template>
                            </div>
                        </div>
                    </div>
                </div>
                <div name="cancel">
                    <div class="row end-xs">
                        <div class="col-xs-6">
                            <div class="box" style="text-align:left;font-size:1.2rem;">
                                ปริมาณที่ยกเลิก {{formatNumber(list.cancel.amount)}} ตัน
                            </div>
                        </div>
                        <div class="col-xs-6">
                            <div class="box">
                                <paper-button class="gl-btn-danger" id="unCancel" on-tap="confirmDialog" hidden="[[list.state.confirm]]" raised>ยกเลิกไม่รับส่วนจัดสรร</paper-button>
                            </div>
                        </div>
                    </div>
                </div>
            </iron-pages>
        </offset-value>

        <iron-pages attr-for-selected="name" selected="[[selected]]">
            <div name="noneConfirm">
                <confirm-list height="[[h]]" height2="[[offH]]" data="{{list.noconfirm.allocate_detail}}" quantity="{{list.quantity}}" status="[[list.noconfirm.status]]"
                    data-select="{{data}}" noconfirm></confirm-list>
            </div>
            <div name="confirmed">
                <confirm-list id="confirm" height="[[h]]" height2="[[offH]]" data="{{list.confirm.allocate_detail}}" quantity="{{list.quantity}}"
                    status="[[list.noconfirm.status]]" data-select="{{data}}" confirm></confirm-list>
            </div>
            <div name="cancel">
                <confirm-list height="[[h]]" height2="[[offH]]" data="{{list.cancel.allocate_detail}}" quantity="{{list.quantity}}" status="[[list.noconfirm.status]]"
                    data-select="{{data}}" confirm></confirm-list>
            </div>
        </iron-pages>

        <nylon-panel-right title="จัดการส่วนจัดสรร" width="90%">
            <confirm-manage status="{{listStatus}}" data-select="{{data}}" data="{{confirmData}}" exporter="{{list}}"></confirm-manage>
        </nylon-panel-right>
        <sheet-tabs select="{{selected}}">
            <sheet-tab name="noneConfirm">
                ยังไม่ยืนยัน {{formatNumber(list.noconfirm.amount)}} ตัน
            </sheet-tab>
            <sheet-tab name="confirmed">
                รับส่วนจัดสรร {{formatNumber(list.confirm.amount)}} ตัน
            </sheet-tab>
            <sheet-tab name="cancel">
                ไม่รับ {{formatNumber(list.cancel.amount)}} ตัน
            </sheet-tab>
        </sheet-tabs>
    </template>
    <script>
        Polymer({
            is: "page-confirm",
            observers: ['setYear(selectYear)', 'getOrdinal(selectYear,data.typeRice)'],
            behaviors: [NylonBehavior, ReduxBehavior, FormatNumberBehavior],
            listeners: { 'open-panel': 'openPanel', 'close-panel': 'closePanel' },
            properties: {
                year: {
                    statePath: 'commonData.year'
                },
                typeRice: {
                    statePath: 'commonData.type_rice'
                },
                selectYear: {
                    statePath: 'commonData.selectYear'
                },
                ordinal: {
                    statePath: 'confirm.ordinal'
                },
                data: {
                    type: Object,
                    value: {}
                },
                list: {
                    statePath: 'confirm.list'
                },
                selectRibbon: {
                    type: String,
                    value: 'home',
                    observer: '_selectRibbonChanged'
                },
                selected: {
                    type: String,
                    value: 'noneConfirm'
                },
            },
            nylonPageActive: function () {
                this.dispatchAction('COMMON_DATA_GET_YEAR');
                if (this.selectYear) {
                    this.dispatchAction('COMMON_DATA_SET_YEAR', this.selectYear);
                    if (this.data.typeRice) this.dispatchAction('CONFIRM_GET_ORDINAL', this.selectYear, this.data.typeRice);
                }
                // this.dispatchAction('COMMON_DATA_GET_TYPE_RICE');
            },
            _selectRibbonChanged: function (val) {
                if (val !== "none") {
                    this.$.collapse.opened = true;
                } else {
                    this.$.collapse.hide();
                }

            },
            closeSearchBox: function () {
                this.selectRibbon = "none"
            },
            confirmDialog:function(e) {
                // console.log(e.currentTarget.id)
                if(e.currentTarget.id == 'addperiod'){
                    this.fire('toast', {
                        status: 'openDialog',
                        text: 'ต้องการยืนยันส่วนจัดสรรใช่หรือไม่ ?',
                        confirmed: this.addperiod.bind(this)
                    })
                }
                else if(e.currentTarget.id == 'cancelperiod'){
                    this.fire('toast', {
                        status: 'openDialog',
                        text: 'ต้องการไม่รับส่วนจัดสรรใช่หรือไม่ ?',
                        confirmed: this.cancelperiod.bind(this)
                    })

                }
                else if(e.currentTarget.id == 'unConfirm'){
                    this.fire('toast', {
                        status: 'openDialog',
                        text: 'ต้องการคืนส่วนจัดสรรใช่หรือไม่ ?',
                        confirmed: this.unConfirm.bind(this)
                    })
                }
                else if(e.currentTarget.id == 'unCancel'){
                    this.fire('toast', {
                        status: 'openDialog',
                        text: 'ต้องการยกเลิกไม่รับส่วนจัดสรรใช่หรือไม่ ?',
                        confirmed: this.unCancel.bind(this)
                    })
                }
            },
            confirmList: function () {
                this.fire('toast', {
                    status: 'openDialog',
                    text: 'ต้องการยืนยันการทำรายการใช่หรือไม่ ?',
                    confirmed: this.actionConfirmList.bind(this)
                })
            },
            actionConfirmList: function (check) {
                if (check == true) {
                    var obj = {
                        year: this.selectYear,
                        type_rice_id: this.data.typeRice,
                        ordinal: parseInt(this.data.ordinal)
                    }
                    console.log(obj);
                    this.dispatchAction('CONFIRM_FININST', obj)
                }
            },
            getOrdinal: function (year, rice) {
                if (year && rice) {
                    this.dispatchAction('CONFIRM_GET_ORDINAL', year, rice);
                }
            },
            searchData: function () {
                this.dispatchAction('CONFORM_SET_DATA', this.data)
                this.dispatchAction('CONFORM_GET_DATA');
            },
            checkStatus: function (val) {
                if (val == 'cf') {
                    return false
                }
                else {
                    return true
                }
            },
            confirmExporter: function () {
                this.fire('toast', {
                    status: 'openDialog',
                    text: 'ต้องอนุมัติส่วนจัดสรรใช่หรือไม่ ?',
                    confirmed: this.aprrove.bind(this)
                })
            },
            confirmSendToEDI: function () {
                this.fire('toast', {
                    status: 'openDialog',
                    text: 'ต้องส่งยอดไป EDI ใช่หรือไม่ ?',
                    confirmed: this.sendToEDIAction.bind(this)
                })
            },
            sendToEDIAction: function (check) {
                if (check) {
                    this.dispatchAction('CONFIRM_SEND_EDI', this.selectYear, this.data.typeRice)
                }
            },
            resize: function (e) {
                var value = e.currentTarget.value;
                // console.log()
                if (value == 'list_1') {
                    this.$$('#list_1').resize()
                }
                else {
                    this.$$('#list_2').resize()
                }
            },
            aprrove: function (check, val) {
                if (check == true) {
                    // console.log(this.list.noconfirm.id);
                    this.dispatchAction('CONFORM_APRROVE', { calculate_id: this.list.noconfirm.id }, this.data)
                }
            },
            setYear: function (year, typeRice) {
                if (year != '' && typeRice != '') {
                    this.set('data.year', year)
                    this.dispatchAction('COMMON_DATA_SET_YEAR', year);
                    // this.dispatchAction('CONFIRM_GET_ORDINAL', year, typeRice);
                }
            },
            getForm: function (val) {
                // var arr = this.list.noconfirm.allocate_detail.filter(function (item) {
                var arr = val.filter(function (item) {
                    return item.check == true;
                })
                // console.log(arr)
                // var exporter = arr.map(function (item) {
                //     var newItem = {
                //         allocate_id : item.id,
                //     }
                //     return newItem;
                // }.bind(this));
                var newItem = {
                    year: this.selectYear,
                    hmcode6: this.data.typeRice,
                    ordinal: parseInt(this.data.ordinal),
                    list: arr
                }
                return newItem;
            },
            addperiod: function (check) {
                if(check == true){
                    // console.log('addperiod')
                    var data = this.getForm(this.list.noconfirm.allocate_detail);
                    var newData = data;
                    newData.list = data.list.map((item) => {
                        var newItem = {
                            allocate_id: item.id,
                        }
                        return newItem
                    })
                    if (newData.list.length != 0) {
                        this.fire('toast', { status: 'load' });
                            this.dispatchAction('CONFIRM_CONFIRM_EXPORTER', newData)
                                .then((res) => {
                                    this.fire('toast', {
                                        status: 'success', text: 'บันทึกสำเร็จ',
                                        callback: () => {
                                            this.dispatchAction('CONFORM_GET_DATA');
                                        }
                                    });
                                })
                                .catch((error) => {
                                    this.fire('toast', {
                                        status: 'connectError', text: error,
                                        callback: function () {
                                        }
                                    })
                                })
                        }
                        else {
                            this.fire('toast', {
                                status: 'connectError', text: 'กรุณาเลือกผู้ส่งออก',
                                callback: function () {
                                }
                            })
                        }
                }
                // console.log(data)
            },
            cancelperiod: function (check) {
                if(check == true){
                    var data = this.getForm(this.list.noconfirm.allocate_detail);
                    var newData = data;
                    newData.list = data.list.map((item) => {
                        var newItem = {
                            allocate_id: item.id,
                        }
                        return newItem
                    })
                    this.fire('toast', { status: 'load' });
                    this.dispatchAction('CONFIRM_NOCONFIRM_EXPORTER', newData.list)
                        .then((res) => {
                            this.fire('toast', {
                                status: 'success', text: 'บันทึกสำเร็จ',
                                callback: () => {
                                    this.dispatchAction('CONFORM_GET_DATA');
                                }
                            });
                        })
                        .catch((error) => {
                            this.fire('toast', {
                                status: 'connectError', text: error,
                                callback: function () {
                                }
                            })
                        })
                    // console.log(data)
                }
               
            },
            unConfirm: function (check) {
                if(check == true){
                    // console.log('unConfirm')
                    var data = this.getForm(this.list.confirm.allocate_detail);
                    var newData = data;
                    newData.list = data.list.map((item) => {
                        var newItem = {
                            company_taxno: item.exporter_id,
                        }
                        return newItem
                    })
                    console.log(newData);
                    this.fire('toast', { status: 'load' });
                    this.dispatchAction('CONFIRM_UNCONFIRM_EXPORTER', newData)
                        .then((response) => {
                            this.fire('toast', {
                                status: 'success', text: 'บันทึกสำเร็จ',
                                callback: () => {
                                    this.dispatchAction('CONFORM_GET_DATA');
                                }
                            });
                            console.log('success!!');
                            console.log(response.data);
                        })
                        .catch((error) => {
                            this.fire('toast', {
                                status: 'connectError', text: error,
                                callback: function () {
                                }                        
                            })
                            console.log('error');
                            console.log(error);
                        });
                }
            },
            unCancel: function (check) {
                if(check == true){
                    // console.log('unCancel')
                    var data = this.getForm(this.list.cancel.allocate_detail);
                    var newData = data;
                    newData.list = data.list.map((item) => {
                        var newItem = {
                            allocate_id: item.id,
                        }
                        return newItem
                    })
                    // console.log(newData.list)
                    this.dispatchAction('CONFIRM_UNCANCEL_EXPORTER', newData.list)
                        .then((res) => {
                            this.fire('toast', {
                                status: 'success', text: 'บันทึกสำเร็จ',
                                callback: () => {
                                    this.dispatchAction('CONFORM_GET_DATA');
                                }
                            });
                        })
                        .catch((error) => {
                            // console.log({error})
                            this.fire('toast', {
                                status: 'connectError', text: error.response.data.error,
                                callback: function () {
                                }
                            })
                        })
                }
            },
            clearperiod: function () {
                var get = this.list.confirm.allocate_detail.filter(function (item) {
                    return item.check == true;
                });
                var datas = get.map((item) => {
                    return obj = {
                        allocate_id: item.allocate_id
                    }
                })
                // console.log(datas);
                if (datas.length != 0) {
                    this.fire('toast', { status: 'load' });
                    this.dispatchAction('CONFIRM_CANCEL_EXPORTER', datas)
                        .then((res) => {
                            this.fire('toast', {
                                status: 'success', text: 'บันทึกสำเร็จ',
                                callback: () => {
                                    this.dispatchAction('CONFORM_GET_DATA');
                                }
                            });
                        })
                        .catch((error) => {
                            // console.log({error})
                            this.fire('toast', {
                                status: 'connectError', text: error.response.data.error,
                                callback: function () {
                                }
                            })
                        })
                }
                else {
                    this.fire('toast', {
                        status: 'connectError', text: 'กรุณาเลือกผู้ส่งออก',
                        callback: function () {
                        }
                    })
                }
            },
            closePanel: function () {
                this.$$('nylon-panel-right').close();
            },
            openPanel: function (e) {
                this.listStatus = e.detail;
                this.$$('nylon-panel-right').open();
            }
        });
    </script>
</dom-module>