<link rel="import" href="components/member-page.html">
<link rel="import" href="./../../../bower_components/polymer/polymer.html">
<link rel="import" href="../components/panel-right/panel-right.html">
<link rel="import" href="../../nylon-behavior.html">
<link rel="import" href="./../../../bower_components/gl-grid/gl-grid-col.html">
<link rel="import" href="./../../../bower_components/gl-grid/gl-grid-row.html">
<link rel="import" href="./../../../bower_components/paper-material/paper-material.html">
<link rel="import" href="./../../../bower_components/gl-form/gl-combo-box.html">
<link rel="import" href="./../../../bower_components/gl-form/gl-form-dropdown-menu.html">
<link rel="import" href="./../../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="./../../../bower_components/paper-item/paper-item.html">
<!--<link rel="import" href="./../../../bower_components/vaadin-date-picker/vaadin-date-picker.html">-->
<link rel="import" href="./../../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="./../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="./../../../bower_components/gl-styles/gl-size.html">
<link rel="import" href="./../../../bower_components/gl-styles/gl-color.html">
<link rel="import" href="./../../../bower_components/gl-styles/gl-table.html">
<link rel="import" href="./../../../bower_components/gl-styles/gl-panel.html">
<link rel="import" href="./../../../bower_components/gl-styles/gl-toast.html">
<link rel="import" href="./../../layout/nylon-toast.html">
<link rel="import" href="../components/validateFormBehaviors.html">
<link rel="import" href="../../../bower_components/vaadin-combo-box/vaadin-combo-box.html">

<link rel="import" href="./../components/nylon-datepicker.html">

<link rel="import" href="./../components/month-behavior.html">
<!--<link href="//getbootstrap.com/2.3.2/assets/css/bootstrap.css" rel="stylesheet" media="screen">-->
<!--<link href="./../../../css/datepicker.css" rel="stylesheet" media="screen">-->
<!--<link href="//getbootstrap.com/2.3.2/assets/js/google-code-prettify/prettify.css" rel="stylesheet">-->
<!--<link href="//getbootstrap.com/2.3.2/assets/css/bootstrap-responsive.css" rel="stylesheet">-->
<!--<script src="//getbootstrap.com/2.3.2/assets/js/jquery.js"></script>-->
<!--<script src="//getbootstrap.com/2.3.2/assets/js/google-code-prettify/prettify.js"></script>-->
<!--<script src="./../../../js/bootstrap-datepicker-thai.js"></script>-->
<!--<script src="./../../../js/locales/bootstrap-datepicker.th.js"></script>-->

<!--<link rel="import" href="./../components/date-picker.html">-->


<dom-module id="page-admin-exporter">
  <style is="custom-style" include=" iron-flex iron-flex-factors iron-flex-alignment gl-size gl-color gl-table gl-toast">
    * {
      font-family: 'CSChatThaiUI', sans-serif !important;
      -webkit-font-smoothing: antialiased;
    }

    .bg-title {
      --vaadin-date-picker-overlay: {
        color: red;
      }
    }

    .title {
      text-align: center;
      font-size: var(--font-size-h3);
    }

    .text-table {
      text-align: center;
      font-size: var(--font-size-h5);
    }

    .searchBox {
      padding: 5px;
      background-color: var(--gl-gray-lighter-color);
    }

    .elevation {
      border-radius: 5px;
      margin: 10px;
      padding: 5px;
    }

    .searchBorder {
      border: 1px solid var(--gl-gray-light-color);
      margin: 15px;
      border-radius: 3px;
    }

    .gl-table-default {
      border-collapse: collapse;
      width: 100%;
      white-space: nowrap;
    }

    paper-material {
      background-color: var(--gl-white-color);
    }

  </style>
  <template>
    <paper-material elevation="1" class="elevation">
      <div class="layout vertical" style="margin: 20px 20px 10px 20px;">
        <div class="layout horizontal end-justified">
          <paper-button raised class="gl-btn-primary" on-tap="_register" title="{{localize.add_exporter}}">
            <iron-icon icon="add"></iron-icon>{{localize.add_exporter}}</paper-button>
        </div>

        <div class="flex title">
          {{localize.title_exporter}}
        </div>

        <div class="searchBox searchBorder">
          <gl-grid-row width="{{getWidth}}">
            <gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,3]]"></gl-grid-col>
            <gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,6]]">
              <!-- <gl-combo-box class="searchForm" label="{{localize.name_exporter}}" items="{{list_search}}" item-label-path="company_name" item-value-path="id"
                value="{{dataSelected.id}}" on-value-changed="_checkID">
                <template>[[item.company_name]]</template>
              </gl-combo-box> -->
              {{searchInput(dataSearch)}}
              <vaadin-combo-box label="{{localize.name_exporter}}" items="{{list_search}}" item-label-path="company_name" item-value-path="id"
                value="{{dataSelected.id}}" on-value-changed="_checkID" loading={{checkLoad}} filter={{dataSearch}}>
                <template>[[item.company_name]]</template>
              </vaadin-combo-box>
            </gl-grid-col>
          </gl-grid-row>

          <gl-grid-row>
            <gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,3]]"></gl-grid-col>
            <gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,2]]">
              <gl-form-dropdown-menu class="searchForm" label="{{localize.type_license}}" placeholder="{{localize.all}}">
                <paper-menu class="dropdown-content" attr-for-selected="value" selected="{{dataSelected.lic_type_id}}" name="lic_type_id">
                  <paper-item>{{localize.all}}</paper-item>
                  <template is="dom-repeat" items={{licType}}>
                    <paper-item value="[[item.lic_type_id]]">{{item.lic_type_name}}</paper-item>
                  </template>
                </paper-menu>
              </gl-form-dropdown-menu>
            </gl-grid-col>
            <gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,2]]">
              <gl-form-dropdown-menu class="searchForm" label="{{localize.status_export}}" placeholder="{{localize.all}}">
                <paper-menu class="dropdown-content" attr-for-selected="value" selected="{{dataSelected.exporter_status}}" name="exporter_status">
                  <paper-item>{{localize.all}}</paper-item>
                  <paper-item value="true">{{localize.member}}</paper-item>
                  <paper-item value="false">{{localize.no_member}}</paper-item>
                </paper-menu>
              </gl-form-dropdown-menu>
            </gl-grid-col>
            <gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,2]]">
              <gl-form-dropdown-menu class="searchForm" label="{{localize.status_exporter}}" placeholder="{{localize.all}}">
                <paper-menu class="dropdown-content" attr-for-selected="value" selected="{{dataSelected.export_status}}" name="exporter_active">
                  <paper-item>{{localize.all}}</paper-item>
                  <paper-item value="true">{{localize.normally}}</paper-item>
                  <paper-item value="false">{{localize.expire}}</paper-item>
                </paper-menu>
              </gl-form-dropdown-menu>
            </gl-grid-col>
          </gl-grid-row>


          <gl-grid-row>
            <gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,2]]"></gl-grid-col>
            <gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,1]]">
              <div style="margin-top:18px; text-align:right;">{{localize.register}}</div>
            </gl-grid-col>
            <gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,3]]">
              <nylon-datepicker value="[[dataSelected.date_start]]" value-return="{{dataSelected.date_start}}">
              </nylon-datepicker>
            </gl-grid-col>
            <div style="margin-top:18px;"> {{localize.to}} </div>
            <gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,3]]">
              <nylon-datepicker value="[[dataSelected.date_end]]" value-return="{{dataSelected.date_end}}">
              </nylon-datepicker>
            </gl-grid-col>
            <gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,2]]"></gl-grid-col>
          </gl-grid-row>

          <gl-grid-row>
            <gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,5]]"></gl-grid-col>
            <gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,3]]">
              <paper-button class="gl-btn-info" style="margin: 30px 0px 10px 50px;" on-tap="_search" title="{{localize.bt_search}}" raised>{{localize.bt_search}}</paper-button>
            </gl-grid-col>
          </gl-grid-row>
        </div>

        <div class="horizontal layout end-justified">
          <div style="margin:30px 10px 0px 20px;">
            <iron-icon icon="print"></iron-icon>
          </div>
          <gl-form-dropdown-menu style="width:250px; margin-right:20px;" placeholder="{{localize.select_report}}" name="report">
            <paper-menu class="dropdown-content" attr-for-selected="report" selected="{{report}}">
              <paper-item on-tap="_report" report="report1">{{localize.report1}}</paper-item>
              <paper-item on-tap="_report" report="report2">{{localize.report2}}</paper-item>
              <paper-item on-tap="_report" report="report3">{{localize.report3}}</paper-item>
            </paper-menu>
          </gl-form-dropdown-menu>
        </div>

        <div class="searchBorder" style="height:600px; overflow-x:auto; overflow-y:auto;">
          <table class="gl-table-default">
            <thead class="table-head">
              <tr>
                <th>
                  <div class="text-table">#</div>
                </th>
                <th>
                  <div class="text-table">{{localize.no_exporter}}</div>
                </th>
                <!--<th>
                  <div class="text-table">{{localize.no_tax}}</div>
                </th>-->
                <th>
                  <div class="text-table">{{localize.name_company}}</div>
                </th>
                <th>
                  <div class="text-table">{{localize.type_license}}</div>
                </th>
                <!--<th>
                  <div class="text-table">{{localize.status_export}}</div>
                </th>-->
                <th>
                  <div class="text-table">{{localize.status_exporter}}</div>
                </th>
                <th>
                  <div class="text-table">{{localize.date_load}}</div>
                </th>
                <th>
                  <div class="text-table">{{localize.date_expire}}</div>
                </th>
              </tr>
            </thead>

            <template is="dom-repeat" items="{{exporters}}">
              <tbody>
                <tr id="detailRegExporter" on-tap="_selectData" data="[[item]]" style="cursor:pointer;">
                  <td>
                    <div class="text-table">[[toIndex(index)]]</div>
                  </td>
                  <td>
                    <div class="text-table">{{item.exporter_no_name}}</div>
                  </td>
                  <!--<td>
                    <div class="text-table">{{item.company_taxno}}</div>
                  </td>-->
                  <td>
                    <div>{{item.company.company_name_th}}</div>
                  </td>
                  <td>
                    <div>{{item.lic_type.lic_type_name}}</div>
                  </td>
                  <!--<td>
                    <div class="text-table">{{item.exporter_status_name}}</div>
                  </td>-->
                  <td>
                    <div class="text-table">{{item.export_status_name}}</div>
                  </td>
                  <td>
                    <div class="text-table">{{toThaiDate(item.date_load2)}}</div>
                  </td>
                  <td>
                    <div class="text-table">{{toThaiDate(item.date_expire2)}}</div>
                  </td>
                </tr>
            </template>

            <template is="dom-if" if={{_checkData(exporters)}}>
              <tr>
                <td colspan="8">
                  <div class="text-table" style="margin:20px">{{localize.not_found}}</div>
                </td>
              </tr>
            </template>
            </tbody>
          </table>
        </div>
      </div>

      <div class="horizontal justified layout" style="margin:0px 40px 10px 40px;">
        <div>
          {{localize.company}}{{localize.all}} [[countExporters(exporters)]] {{localize.company}}
        </div>
        <div>
          {{localize.page}}
          <select id="selectedPage" on-change="selectPage">
              <template is="dom-repeat" items={{pages}}>
                  <option value="{{item}}">{{item}}</option>
              </template>
          </select> / [[countPage(pages)]] {{localize.page}}
        </div>
      </div>

    </paper-material>

    <panel-right title="{{titleName}}">
      <div class="left">
        <iron-pages selected="{{layerContent}}" attr-for-selected="name">
          <div name="detailRegExporter">
            <member-page></member-page>
            <!--<member-page data="{{dataSelect}}" doc-type="[[docType]]" list-files="{{listFiles}}" type-lic="{{licType}}"></member-page>-->
          </div>
        </iron-pages>
      </div>
    </panel-right>

  </template>
  <script>
    Polymer({
      is: "page-admin-exporter",
      properties: {
        layerContent: {
          type: String,
          value: "detailRegExporter"
        },
        dataSelected: {
          type: Object,
          value: {}
        },
        localize: {
          statePath: 'i18n.exporter'
        },
        exporters: {
          statePath: 'exporter.list'
        },
        list_search: {
          statePath: 'exporter.list_search',
          observer: 'checkDataSearch'
        },
        licType: {
          statePath: 'exporter.licType'
        },
        pages: {
          statePath: 'exporter.pages'
        }
      },
      behaviors: [ReduxBehavior, nylonBehavior, i18nAction, exporterAction, uploadAction, ValidateFormBehavior, MonthBehavior],
      nylonPageActive: function () {
        this.dispatchAction('EXPORTER_GET_DATA');
        // this.dispatchAction('EXPORTER_GET_DATA_SEARCH');
        this.dispatchAction('EXPORTER_GET_LIC_TYPE');
        this.dispatchAction('EXPORTER_GET_PAGE');
      },
      attached() {
        this.async(() => {
          // console.log(this.$$('.datepicker'));
        }, 2500)
        let date = new Object()
        let today = new Date(new Date().setFullYear(new Date().getFullYear()))
        ////console.log(today);
        let month = today.getMonth() + 1
        if (month < 10)
          month = '0' + month
        // console.log(month);
        // console.log(today.toISOString());
        // dateStart = today.toISOString().split('T')[0]
        dateStart = today.getFullYear() + 543 + '-' + month + "-" + today.getDate()
        // console.log(dateStart.toISOString())
        // console.log(dateStart);
        // console.log(today.getDate());
        let nextDay = dateEnd = new Date(today.setDate(today.getDate() + 7)).toISOString().split('T')[0]
        // console.log(nextDay.split('-')[2]);
        dateEnd = today.getFullYear() + 543 + '-' + month + "-" + nextDay.split('-')[2]

        this.set('dataSelected.date_start', dateStart)
        this.set('dataSelected.date_end', dateEnd)
        // dataSelected.date_end}
        //         console.log(dateStart,dateEnd);
      },
      searchInput: function (val) {
        this.checkLoad = true;
        let reg_num = new RegExp('[0-9]');
        let reg_char_th = new RegExp('[ก-๙]');
        let reg_char_en = new RegExp('[a-zA-Z]');

        this.debounce('searchInput', () => {
          if (typeof val !== 'undefined' && val.length >= 3) {
            if (reg_num.test(val) === true) {
              this.dispatchAction('EXPORTER_GET_DATA_SEARCH', { att_name: 'company_taxno', val: val, type: 'number' });
            } else if (reg_char_th.test(val) === true) {
              this.dispatchAction('EXPORTER_GET_DATA_SEARCH', { att_name: 'company_name_th', val: val, type: 'char_th' });
            } else if (reg_char_en.test(val) === true) {
              this.dispatchAction('EXPORTER_GET_DATA_SEARCH', { att_name: 'company_name_en', val: val, type: 'char_en' });
            }
          } else {
            // console.log('clear');
            this.dispatchAction('EXPORTER_CLEAR_LIST_SEARCH');
          }
        }, 500)
      },
      checkDataSearch(val) {
        this.checkLoad = false;
      },
      _register: function (e) {
        window.open('./admin-confirm');
      },
      _selectData: function (e) {
        // console.log(e.currentTarget.data.company_taxno);
        // company_taxno
        var companyId = e.currentTarget.data.company_id;
        this.dispatchAction('EXPORTER_GET_FILE_DELETE', companyId);
        var id = e.currentTarget.data.id;
        let company_taxno = e.currentTarget.data.company_taxno
        this.dispatchAction('EXPORTER_GET_DATA_ID', id, company_taxno);
        this.dispatchAction('EXPORTER_GET_LIC_TYPE');
        this.dispatchAction('EXPORTER_GET_DOC_TYPE');
        this.layerContent = "detailRegExporter";
        this.titleName = 'ข้อมูลผู้ส่งออก';
        this.$$('panel-right').open();
        this.$$('member-page')._backpage();
      },
      _checkID: function (id) {
        if (id.detail.value !== "" && typeof id.detail.value !== 'undefined') {
          var id = id.detail.value;
          this.dispatchAction('EXPORTER_GET_DATA_ID', id);
          this.dispatchAction('EXPORTER_GET_LIC_TYPE');
          this.dispatchAction('EXPORTER_GET_DOC_TYPE');
          this.layerContent = "detailRegExporter";
          this.titleName = 'ข้อมูลผู้ส่งออก';
          this.$$('panel-right').open();
          this.$$('member-page')._backpage();
          var searchId = this.exporters.filter((item) => {
            return item.id == id
          })
          var companyId = searchId[0].company_id;
          this.dispatchAction('EXPORTER_GET_FILE_DELETE', companyId);

        }
      },
      genUrl(url) {
        let data = new String()
        let url_length = Object.getOwnPropertyNames(url).length
        let count = new Number()
        // //console.log(url);
        for (var variable in url) {
          if (url[variable] != '') {
            data = data + variable + "=" + url[variable];
            (count < url_length - 1) ? data += '&' : '';
          }
          count++
        }
        // //console.log(data);
        return data
      },
      _search: function (type) {
        // this.fire('toast', { status: 'load' })
        // console.log(this.dataSelected);
        var page = this.$$('#selectedPage').value;
        var str = '';

        if (this.dataSelected.date_start != undefined && this.dataSelected.date_start != '' && (this.dataSelected.date_end == undefined || this.dataSelected.date_end == '')) {
          this.fire('toast', { status: 'connectError', text: 'กรุณาใส่วันที่สิ้นสุดค้นหา' })
        }
        else if (this.dataSelected.date_end != undefined && this.dataSelected.date_end != '' && (this.dataSelected.date_start == undefined || this.dataSelected.date_start == '')) {
          this.fire('toast', { status: 'connectError', text: 'กรุณาใส่วันที่เริ่มต้นค้นหา' })
        } else {
          if (this.dataSelected.date_start !== '' & this.dataSelected.date_end != '') {
            let date = JSON.parse(JSON.stringify(this.dataSelected));
            date.date_start = (Number(date.date_start.split('-')[0]) - 543) + '-' + date.date_start.split('-')[1] + '-' + date.date_start.split('-')[2]
            date.date_end = (Number(date.date_end.split('-')[0]) - 543) + '-' + date.date_end.split('-')[1] + '-' + date.date_end.split('-')[2]
            // console.log(date)
            str = this.genUrl(date)
          }
          // console.log(str);
          // for (key in this.dataSelected) {
          //   if (this.dataSelected[key] != '' && this.dataSelected[key] != null) {
          //     if (str == '') { str += '?' } else { str += '&' }
          //     str += key + '=' + this.dataSelected[key];
          //     // str += '&' + key + '=' + this.dataSelected[key];
          //   }
          // }
          this.dispatchAction('EXPORTER_SEARCH', str, page, type);
          // console.log(this.queryFrom('.searchForm'));
          this.queryFrom('.searchForm').map((el) => el.reset());
          return str;
        }
      },
      _report: function (e) {
        var str = this._search('report');
        window.open('./api/external/report_exporter/' + e.target.getAttribute('report') + (str != '' ? str : ''), '_blank');
      },
      _checkData: function (val) {
        if (val.length > 0) {
          return false
        }
        else {
          return true
        }
      },
      toIndex: function (index) {
        return index + 1;
      },
      selectPage: function () {
        var page = this.$$('#selectedPage').value;
        this.dispatchAction('EXPORTER_GET_DATA', page);
      },
      countPage: function (page) {
        return page.length
      },
      countExporters: function (val) {
        return numeral(val.length).format('0,0');
      }
    });
  </script>
</dom-module>