<link rel="import" href="../../../bower_components/vaadin-combo-box/vaadin-combo-box.html">
<link rel="import" href="../../layout/shared-styles.html">
<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../nylon-behavior.html">
<link rel="import" href="../components/nylon-panel-right.html">
<link rel="import" href="../components/page-header.html">
<link rel="import" href="../components/page-panel.html">
<link rel="import" href="../../../bower_components/vaadin-date-picker/vaadin-date-picker.html">
<link rel="import" href="./components/notice-list.html">
<link rel="import" href="./components/notice-manage.html">
<link rel="import" href="../../redux-behavior.html">
<link rel="import" href="./../../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="./components/notice-upload.html">
<link rel="import" href="../../../bower_components/paper-item/paper-item-body.html">
<link rel="import" href="../../../bower_components/iron-image/iron-image.html">
<link rel="import" href="../../../bower_components/paper-item/paper-icon-item.html">

<dom-module id="page-notice">
  
  <template>
    <style include="shared-styles">
      #page1:checked~#content1,
      #page2:checked~#content2 {
          display: block;
      }
      .section{
        padding:0.5rem;
      }
      .page{
        height: calc(100vh - 64px);
      }
    </style>

    <div class="page">
    <page-header label="ออกประกาศ">
      <!--<paper-button class="gl-btn-primary" on-tap="openPanel" raised>ออกประกาศ</paper-button>-->
    </page-header>

    <div class="white-space"></div>

   <main>
      <input id="page1" on-click="resize" value="list_1" type="radio" name="tabs" checked>
      <label for="page1">ออกประกาศ</label>

      <input id="page2" on-click="resize" value="list_2" type="radio" name="tabs">
      <label for="page2">อัพโหลดประกาศ</label>

      <section id="content1">
      
        <!-- <page-panel>
          <div class="row start-xs">
            <div class="col-xs-2">
              <div class="box">
                  <vaadin-combo-box label="แสดงข้อมูลรายปี" items="[[year]]" value="{{selectYear}}"></vaadin-combo-box>
              </div>
            </div>
          </div>
        </page-panel> -->

        <div class="page">
        
          <page-panel>
            <div class="box">

              <div class="row between-xs">
                <div class="col-xs-12 col-sm-4 col-md-2">
                  <vaadin-combo-box label="แสดงข้อมูลรายปี" items="[[year]]" value="{{selectYear}}"></vaadin-combo-box>
                </div>
                <div class="col-xs-12 col-sm-4 col-md-2" style="text-align:right">
                  <paper-button class="gl-btn-primary" on-tap="selectTypeDoc" raised>ออกประกาศ</paper-button>
                </div>
              </div>
              <div class="section">
                 <template is="dom-repeat" items="{{data}}">
                  <div class="row">
                    <div class="col-xs-12" style="padding:0.4rem">
                      <b>ประเภทข้าว : {{item.type_rice_name_th}}</b>
                    </div>
                    <div class="col-xs-12">
                      <notice-list data="{{item.row}}" year-select="[[selectYear]]" on-open-panel="openPanel"></notice-list>
                    </div>
                    <div style="margin:1rem"></div>
                  </div>
                </template>
              </div>
            </div>
          </page-panel>
        </div>
      </section>
      <section id="content2">
        <page-panel label="รายการไฟล์ประกาศ">
          <div class="box">
             <notice-upload></notice-upload>
          </div>
        </page-panel>
      </section>
   </main>
    </div>  
    <nylon-panel-right title="จัดการประกาศ">
      <notice-manage on-search="getData" status="{{data.length}}" year-select="[[selectYear]]"></notice-manage>
    </nylon-panel-right>

    <paper-dialog id="dropdownDialog" modal>
			<h2>เลือกประเภทเอกสาร</h2>
			<vaadin-combo-box label="เลือกประเภทเอกสาร" items="[[typeDocs]]" value="{{selectType}}">
      </vaadin-combo-box>
      <div class="buttons">
        <paper-button dialog-dismiss>ปิด</paper-button>
        <paper-button class="gl-btn-primary" on-tap="exportReport">ออกประกาศ</paper-button>
      </div>
		</paper-dialog>

  </template>
  <script>
    Polymer({
      is: "page-notice",
      behaviors: [NylonBehavior,ReduxBehavior],
      observers:['getData(selectYear)'],
      properties:{
        year:{
          statePath:'commonData.year'
        },
        data:{
          statePath:'notice.data'
        },
        selectYear:{
          statePath:'commonData.selectYear'
        },
        typeDocs:{
          type:Array,
          value:[
            {
              label:'word',
              value: 'word',
              path: '../../../images/icons/word.png'
            },
            {
              label:'excel',
              value: 'excel',
              path: '../../../images/icons/excel.png'
            },
            {
              label:'pdf',
              value: 'pdf',
              path: '../../../images/icons/pdf.png'
            }
          ]
        },
        selectType:{
          type:String
        }
      },
      nylonPageActive:function(){
        this.dispatchAction('COMMON_DATA_GET_YEAR');
        this.dispatchAction('NOTICE_GET_FILE_LIST');
        if(this.selectYear) this.dispatchAction('NOTICE_GET_DATA',this.selectYear);
        // this.dispatchAction('COMMON_DATA_GET_TYPE_RICE');
      },
      getData:function(year){
        if(year){
          this.dispatchAction('COMMON_DATA_SET_YEAR',year);
          this.dispatchAction('NOTICE_GET_DATA',year);
        }
        // console.log(e.target.value);
        
      },  
      openPanel:function(){
        this.$$('nylon-panel-right').open();
      },
      selectTypeDoc:function(){
         Polymer.dom(this.root).querySelector('#dropdownDialog').open()
      },  
      exportReport:function(){
        Polymer.dom(this.root).querySelector('#dropdownDialog').close()
        var data = Polymer.dom(this.root).querySelectorAll('notice-list').map((item=>{
          return item.getValueForReport()
        }))
        var queryString = ""
        var id = data.map((id)=>{
            if(id){
                var comma = "";
                if(queryString!=""){comma=","}
                queryString = queryString+comma+id;
            }
        })
        queryString= queryString+'&type='+this.selectType;
        // console.log(queryString);
        window.open('/api/notify/report?calculate_id='+queryString,'_blank');
      }
    });
  </script>
</dom-module>