<link rel="import" href="components/list-company.html">
<link rel="import" href="components/detail-company.html">
<link rel="import" href="components/fileup-company.html">
<link rel="import" href="components/company-page.html">
<link rel="import" href="./../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../nylon-behavior.html">
<link rel="import" href="../components/panel-right/panel-right.html">
<link rel="import" href="./../../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="./../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="./../../../bower_components/gl-styles/gl-size.html">
<link rel="import" href="./../../../bower_components/gl-styles/gl-color.html">
<link rel="import" href="./../../../bower_components/gl-styles/gl-table.html">
<!--<link rel="import" href="./../../../bower_components/gl-styles/gl-panel.html">-->
<link rel="import" href="./../../../bower_components/gl-styles/gl-toast.html">
<link rel="import" href="./../../../bower_components/gl-form/gl-form-input.html">
<link rel="import" href="./../../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="./../../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="./../../../bower_components/paper-tabs/paper-tab.html">
<link rel="import" href="./../../../bower_components/gl-form/gl-form-panel.html">
<link rel="import" href="./../../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="./../../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="./../../../bower_components/gl-grid/gl-grid-col.html">
<link rel="import" href="./../../../bower_components/gl-grid/gl-grid-row.html">
<link rel="import" href="./../../../bower_components/gl-form/gl-form-textarea.html">
<link rel="import" href="./../../../bower_components/gl-form/gl-form-dropdown-menu.html">
<link rel="import" href="./../../../bower_components/gl-form/gl-form-input.html">
<link rel="import" href="./../../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="./../../../bower_components/paper-item/paper-item.html">

<dom-module id="page-admin-confirm">
  <style is="custom-style" include="iron-flex iron-flex-factors iron-flex-alignment gl-size gl-color gl-table gl-toast">
    * {
      font-family: 'CSChatThaiUI', sans-serif;
      -webkit-font-smoothing: antialiased;
    }
    .marginCheckbox {
      margin: 10px 0px 0px 30px;
    }
    .searchBorder {
      border: 1px solid var(--gl-gray-light-color);
      margin: 15px;
      border-radius: 3px;
      background-color: #fff;
    }
    .text-table {
      text-align: center;
      font-size: var(--font-size-h5);
    }
    .gl-table-default {
      border-collapse: collapse;
      width: 100%;
      white-space: nowrap;
    }
    .tabs {
      background-color: #f7941e;
      margin: 0px 15px 0px 15px;
      color: #F2F2F2;
      --paper-tabs-selection-bar: {
        height: 5px;
        background-color: var(--gl-info-color);
      }
    }
    .tab:focus>div.tab-content {
      background-color: yellow;
      opacity: 1;
      font-weight: 0;
    }
    .tab:not(:last-of-type) {
      border-right: 3px solid var(--gl-gray-light-color);
      font-size: var(--font-size-h5);
    }
    .tabs .tab.iron-selected {
      font-size: var(--font-size-h5);
      color: var(--gl-white-color);
      background-color: var(--gl-info-color);
    }
    .table-head>tr>th:nth-child(2) {
      width: 15%;
    }
    .btn{
      margin:15px 20px 5px 10px;
    }
    .btn-bottom{
      margin:0px 15px 15px 0px;
    }
    main {
      padding: 5px;
      margin: 0 auto;
    }

    section {
      display: none;
      border-top: 1px solid #ddd;
    }

    input {
      display: none;
    }

    label {
      display: inline-block;
      margin: 0 0 -1px;
      padding: 15px 25px;
      font-weight: 600;
      text-align: center;
      color: #bbb;
      border: 1px solid transparent;
      background: #D5D8DC;
    }

    label:before {
      font-family: fontawesome;
      font-weight: normal;
      margin-right: 10px;
    }

    label:hover {
      color: #888;
      cursor: pointer;
    }

    input:checked+label {
      color: #555;
      border: 1px solid #ddd;
      border-top: 3px solid orange;
      border-bottom: 1px solid #fff;
      background: #fff;
    }

    #tab1:checked~#content1,
    #tab2:checked~#content2 {
      display: block;
    }

    .container {
      display: inline-block;
      margin-left: 30px;
      margin-right: 30px;
    }
    /* Need to position the badge to look like a text superscript */

    .container>paper-badge {
      --paper-badge-margin-left: 20px;
      --paper-badge-margin-bottom: 0px;
    }
  </style>
  <template>
    <div class="horizontal layout center-justified" style="margin-top:10px;">
      <gl-form-input hidden="{{isHidden}}" style="width:300px;" label="{{localize.tax_no}} :" value="{{companyId}}" always-float-label allowed-pattern="[0-9]" maxlength="13">
        <iron-icon icon="search" prefix style="width:20px;height:30px;"></iron-icon>
        <paper-icon-button suffix on-tap="clearData" icon="clear" title="clear" style="height:30px;">
      </gl-form-input>
      <paper-button hidden="{{isHidden}}" class="gl-btn-info btn" raised on-tap="_search">{{localize.bt_search}}</paper-button>
    </div>
    <!-- <main>
      <input id="tab1" type="radio" name="tabs" checked on-tap="tap1">
      <label for="tab1">
        <div class="container" tabindex="0">
        <span>1.{{localize.allocate_unsuccess}}</span>
        <paper-badge label="{{unallocated_fees.length}}" style="left: 244.813px; top: 28px;"></paper-badge>
      </div>
      </label>

      <input id="tab2" type="radio" name="tabs"  on-tap="tap2">
      <label for="tab2">
        <div class="container" tabindex="0">
          <span>2.{{localize.allocate_success}}</span>
          <paper-badge label="{{allocate_fees.length}}" style="left: 529.234px; top: 28px;"></paper-badge>
          </div>
      </label>

      <section id="content1"> -->
        <iron-pages selected="{{pageSelected}}" attr-for-selected="name">
          <div name="listCompany">
            <!-- <list-company></list-company> -->
              <div class="searchBorder" style="overflow-x:auto;">
              <table class="gl-table-default">
                <thead class="table-head">
                  <tr>
                    <th><div class="text-table">{{localize.No}}</div></th>
                    <th><div class="text-table">{{localize.no_exporter_fullname}}</div></th>
                    <th><div class="text-table">{{localize.name_company}}</div></th>
                    <th><div class="text-table">{{localize.type_license}}</div></th>
                    <th><div class="text-table">{{localize.date_register}}</div></th>
                    <th><div class="text-table">{{localize.status}}</div></th>
                  </tr>
                </thead>

                <template is="dom-repeat" items="{{companys}}">
                  <tbody>
                    <tr style="cursor:pointer;">
                      <td><div class="text-table">[[indexNo(index)]]</div></td>
                      <td style="text-align:center"><gl-form-input value="{{item.exporter_no}}" on-blur="changeNo" data="[[item]]" allowed-pattern="[0-9]"></gl-form-input></td>
                      <td on-tap="_selectData" data="[[item]]"><div>{{item.company.company_name_th}}</div></td>
                      <td on-tap="_selectData" data="[[item]]"><div>{{item.type_lic.type_lic_name}}</div></td>
                      <td on-tap="_selectData" data="[[item]]"><div class="text-table">{{item.date_created}}</div></td>
                      <td on-tap="_selectData" data="[[item]]"><div>{{item.approve_status_name}}</div></td>
                    </tr>
                </template>
                <template is="dom-if" if={{_checkData(companys)}}>
                  <tr>
                      <td colspan="6"><div class="text-table" style="margin:20px">{{localize.not_found}}</div></td>
                  </tr>
                </template>
                  </tbody>
              </table>
            </div> 
          </div>

          <div name="detailCompany">
             <paper-tabs selected="{{pages}}" align-bottom no-slide class="tabs">
              <paper-tab class="tab">{{localize.detail}}</paper-tab>
              <paper-tab id="tabFile" class="tab">{{localize.doc_ev}}</paper-tab>
            </paper-tabs>
            <gl-form-panel>
              <iron-pages selected="{{pages}}">
                <detail-company exporter-data="[[exporter_data]]"></detail-company>
                <fileup-company exporter-data="[[exporter_data]]"></fileup-company>
              </iron-pages>
            </gl-form-panel>

            <div class="horizontal layout justified">
              <div>
                <paper-button hidden="[[_hidBtnPass(dataSelect.approve_status)]]" class="gl-btn-warning" style="margin-left:15px;" on-tap="_dialogRemark" raised>{{localize.bt_no_pass}}</paper-button>
                <div hidden="[[_hidBtnApp(dataSelect.approve_status)]]" style="margin-left:20px;">
                  <div class="btn-bottom">
                    <iron-icon icon="print"></iron-icon>
                    <paper-dropdown-menu style="width:300px" placeholder="{{localize.select_report}}" no-label-float name="report">
                      <paper-tabs class="dropdown-content" attr-for-selected="report" selected="{{report}}">
                        <paper-tab on-tap="_print" report="report1">{{localize.memorandum}}</paper-tab>
                        <paper-tab on-tap="_print" report="report2">{{localize.confirmation}}</paper-tab>
                      </paper-tabs>
                    </paper-dropdown-menu>
                  </div>
                </div>
              </div>
              <div>
                <paper-button on-tap="_backPage" raised>{{localize.bt_back}}</paper-button>
                <paper-button hidden="[[_hidBtnPass(dataSelect.approve_status)]]" class="gl-btn-success btn-bottom" on-tap="_save" raised>{{localize.bt_pass}}</paper-button>
                
                <template is="dom-if" if={{isEnabled}}>
                  <paper-button hidden="[[_hidBtnApp(dataSelect.approve_status)]]" class="gl-btn-success btn-bottom" on-tap="approve" raised>{{localize.bt_approve}}</paper-button>
                </template>
                
                <template is="dom-if" if={{!isEnabled}}>
                  <template is="dom-if" if={{obExporter(exporter_data.expire_status)}}>
                    <paper-button class="gl-btn-warning btn-bottom" on-tap="_extend" raised>{{localize.bt_exporter_extend}}</paper-button>
                  </template>
                  <template is="dom-if" if={{!obExporter(exporter_data.expire_status)}}>
                    <paper-button hidden="[[_hidBtnApp(dataSelect.approve_status)]]" class="gl-btn-success btn-bottom" on-tap="approve" raised>{{localize.bt_approve}}</paper-button>
                  </template>
                </template>
              </div>
            </div> 
          </div> 

          <div name="register">
            <company-page></company-page>
          </div> 
        </iron-pages>
        <paper-dialog id="dialog" style="width:60%;">
          <gl-grid-row width="{{getWidth}}">
            <gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,12]]">
              <gl-form-textarea label="{{localize.note}} : " always-float-label value="{{company_remark}}"></gl-form-textarea>
            </gl-grid-col>
          </gl-grid-row>
          <div>
            <paper-button class=" button-size" raised on-tap="_dialogcancle">{{localize.bt_back}}</paper-button>
            <paper-button class="gl-btn-primary button-size" raised on-tap="_reject">{{localize.bt_save}}</paper-button>
          </div>
        </paper-dialog>  
        [[obData(dataSelect)]]
       <!-- </section> -->

      <!-- <section id="content2"> -->
        <!-- <list-of-fee-detail data="{{list_fee}}"></list-of-fee-detail> -->
      <!-- </section>
    </main>  -->
    
  </template>
  <script>
    Polymer({
      is: "page-admin-confirm",
      properties: {
        pages:{
          type: String,
          value: 0
        },
        pageSelected: {
          type: String,
          value: 'listCompany'
        },
        data: {
          type: Array,
          value: []
        },
        selectDataAll: {
          type: Boolean,
          value: false,
          observer: '_changeselectDataAll'
        },
        isHidden:{
          type: Boolean,
          value: false
        },
        localize:{
          statePath : 'i18n.exporter'
        },
        companys:{
          statePath : 'confirm.list'
        }
      },
      behaviors: [ReduxBehavior, nylonBehavior, i18nAction, confirmAction, exporterAction],
      listeners: {
        'back_page' : '_backPage',
        'clearData' : 'clearData'
      },
      nylonPageActive: function () {
        this.dispatchAction('CONFIRM_GET_DATA');
        this.dispatchAction('EXPORTER_GET_TYPE_LIC');
        this.dispatchAction('EXPORTER_GET_DOC_TYPE');
      },
      _selectData: function (e) {
        this.isHidden = true;
        this.pageSelected = "detailCompany";
        this.dataSelect = e.currentTarget.data;
        // console.log(e.currentTarget.data);
        var companyId = e.currentTarget.data.company_taxno;
        this.dispatchAction('CONFIRM_SEARCH', companyId);
      },
      _backPage: function (data) {
        this.pageSelected = 'listCompany';
        this.pages = 0;
        this.isHidden = false;
      },
      _save: function () {
        var data = {
                      id: this.dataSelect.id,
                      company_id: this.dataSelect.company_id,
                      exporter_no: this.dataSelect.exporter_no,
                      approve_status: 'process'
                    };
        // console.log(data);
        this.fire('toast', {
          status: 'openDialog',
          text: 'เอกสารครบถ้วนแล้วใช่หรือไม่ ?',
          confirmed: (result) => {
            if (result == true) {
              this.dispatchAction('CONFIRM_ACCEPT_PASS', data);
            }
          }
        });
      },
      approve: function () {
        this.fire('toast', {
          status: 'openDialog',
          text: 'คุณต้องการจะอนุมัติใช่หรือไม่ ?',
          confirmed: (result) => {
            if(result == true){
              this.dispatchAction('CONFIRM_ADMIN_APPROVE', this.dataSelect, this.exporter_data);
            }
          }
        });
      },
      _changeselectDataAll: function (val) {
        // console.log(val);
        if (typeof this.companys != 'undefined') {
          this.companys.map((item, index) => {
            // if (item.approve_status == "process") {
            this.set('companys.' + index + '.check', val);
            // }
          });
        }
      },
      _close: function () {
        this.fire('close-toggle');
      },
      _dialogRemark: function () {
        this.$.dialog.toggle();
        // console.log(this.dataSelect);
      },
      _dialogcancle: function () {
        this.$.dialog.toggle();
        this.company_remark = "";
      },
      _reject: function () {
        if(this.company_remark === undefined){
          this.company_remark = '';
        }
        var data= {
                    id: this.dataSelect.id,
                    company_id: this.dataSelect.company_id,
                    approve_status: 'reject',
                    company_remark: this.company_remark
                  }
        this.fire('toast', {
          status: 'openDialog',
          text: 'คุณต้องการจะให้ผู้ส่งออกส่งเอกสารเพิ่มเติมใช่หรือไม่ ?',
          confirmed: (result) => {
            if(result == true){
              this.dispatchAction('CONFIRM_ADMIN_REJECT', data);
              this.$.dialog.toggle()
              this.company_remark = "";
              this._backPage();
            }
          }
        });
      },
      _extend:function(){
        var data = {
                      id: this.exporter_data.exporter_id,
                      confirm_id: this.dataSelect.id,
                      change_status: this.exporter_data.change_status
                    };
        this.fire('toast', {
          status: 'openDialog',
          text: 'คุณต้องการจะต่ออายุผู้ส่งออกใช่หรือไม่ ?',
          confirmed: (result) => {
            if( result == true){
              this.dispatchAction('CONFIRM_ADMIN_EXTEND', data);
              this.pageSelected = 'listCompany';
            }
          }
        });
      },
      changeNo: function (e) {
        var company = e.currentTarget.data;
        var datas = {
          id: company.id,
          exporter_no: parseInt(company.exporter_no),
          company_id: company.company_id
        }
        // console.log(datas);
        this.read('./external/check/duplicate?table=confirm_exporter&field=exporter_no&value=' + datas.exporter_no, (response) => {
          if (response == 0) {
            this.fire('toast', { status: 'load', text: 'กำลังบันทึกข้อมูล...' })
            this.update('./external/confirm_exporter/update', datas, () => {
              this.fire('toast', {
                status: 'success', text: 'บันทึกสำเร็จ', callback: () => {
                  this.fire('refresh-company');
                  // console.log('success');
                }
              });
            });
          }
          else {
            this.read('./external/check/myowner?table=confirm_exporter&id=' + datas.id + '&field=exporter_no&value=' + datas.exporter_no, (response) => {
              if (response == 1) {
                this.fire('toast', { status: 'load', text: 'กำลังบันทึกข้อมูล...' })
                this.update('./external/confirm_exporter/update', datas, () => {
                  this.fire('toast', {
                    status: 'success', text: 'บันทึกสำเร็จ', callback: () => {
                      this.fire('refresh-company');
                      // console.log('success');
                    }
                  });
                });
              }
              else {
                this.fire('toast', {
                  status: 'connectError', text: 'เลข ข. นี้มีอยู่แล้ว',
                  callback: function () {
                  }
                })
              }
            });
          }
        });
      },
      _print: function (e) {
        // console.log(e.target.getAttribute('report'));
        if(e.target.getAttribute('report') == 'report1'){
          if(typeof this.exporter_data !== 'undefined'){
            if(this.exporter_data.expire_status === true){
              // console.log('หมดอายุ');
              window.open('./api/external/report_exporter/approve_renew_1/'+this.dataSelect.id);
            }else{
              // console.log('ไม่หมดอายุ');
              window.open('./api/external/report_exporter/approve_changtype/'+this.dataSelect.id);
            }
          }else{
              window.open('./api/external/report_exporter/approve_general_1/'+this.dataSelect.id);
          }
        }else{
          if(typeof this.exporter_data !== 'undefined'){
            window.open('./api/external/report_exporter/approve_renew_2/'+this.dataSelect.id);
          }else{
            window.open('./api/external/report_exporter/approve_general_2/'+this.dataSelect.id);
          }
        }
        
      },
      _search: function () {
        if(this.companyId != ''){
          this.dispatchAction('CONFIRM_SEARCH',this.companyId);
          this.pageSelected = "register";
        }
        else{
          this.fire('toast', { status: 'connectError', text: 'กรุณากรอกเลขประจำตัวผู้ส่งออก' })
        }
      },
      clearData: function(){
        this.idCompany = {};
        this.companyId = '';
        this._backPage();
      },
      obData: function(val){
        // console.log(val)
        this.dispatchAction('CONFIRM_OB_DATA', val.id)
        .then((response) => {
          console.log(response.data);
          this.exporter_data = response.data[0];
          if(typeof this.exporter_data === 'undefined'){
            this.isEnabled = true;
          }else{
            this.isEnabled = false;
          }
        })
      },
      obExporter:function(val){
        if(typeof val === 'undefined' && val == undefined){
          return true
        }else if(val === true){
          return true
        }else{
          return false
        }
      },
      _hidBtnApp:function(val){
        if(val == 'process'){
          return false
        }else{
          return true
        }
      },
      _hidBtnPass:function(val){
        if(val == 'request'){
          return false
        }else{
          return true
        }
      },
      indexNo:function(val){
        return val+1
      },
      _checkData:function(val){
        if(val.length > 0){
          return false
        }else{
          return true
        }
      },
      // _approveAll: function () {
      //   const check = (item) => {
      //     return item.check == true;
      //   }
      //   this.companys.filter(check).map((datas) => {
      //     // console.log(datas);
      //     let { exporter_no, company_id, id, exporter_status, type_lic_id} = datas;
      //     let newData = { exporter_no, company_id, exporter_status, type_lic_id};
      //     newData.confirm_id = datas.id
      //     // console.log(newData);
      //     this.data.push(newData);
      //   });
      //   this.fire('toast', {
      //     status: 'openDialog',
      //     text: 'คุณต้องการจะอนุมัติใช่หรือไม่ ?',
      //     confirmed: this._confirm.bind(this)
      //   });
      // },
      // _confirm: function (result, detail) {
      //   this.data.map((datas) => {
      //     datas = {
      //       confirm_id: datas.id,
      //       company_id: datas.company_id,
      //       exporter_no: datas.exporter_no
      //     }
      //     if (result == true) {
      //       // console.log(datas);
      //       this.fire('toast', { status: 'load', text: 'กำลังบันทึกข้อมูล...' })
      //       this.insert('./external/confirm_exporter/insert', datas, () => {
      //         this.fire('toast', {
      //           status: 'success', text: 'บันทึกสำเร็จ', callback: () => {
      //             this.fire('refresh-company');
      //             this.fire('refresh-exporter');
      //             this.fire('refresh-listcompany');
      //             this.selectDataAll = false;
      //             // console.log('success');
      //           }
      //         });
      //       });
      //     }
      //   });
      // }
    });
  </script>
</dom-module>