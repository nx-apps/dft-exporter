<link rel="import" href="./../../../../bower_components/polymer/polymer.html">
<link rel="import" href="./../../../layout/shared-styles.html">
<link rel="import" href="./../../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="./../../../../bower_components/vaadin-combo-box/vaadin-combo-box.html">
<link rel="import" href="../../components/page-header.html">
<link rel="import" href="../../components/page-panel.html">
<link rel="import" href="../../../nylon-behavior.html">
<link rel="import" href="../../../redux-behavior.html">
<link rel="import" href="./../../../month-behavior.html">
<link rel="import" href="./../../../../bower_components/iron-a11y-keys/iron-a11y-keys.html">
<link rel="import" href="./../../../../bower_components/paper-item/paper-item.html">
<link rel="import" href="./../../../../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="./../../components/format-number-behavior.html">
<dom-module id="exporter-report2-form">
    <template>
        <style include="shared-styles">
            #tabmain1:checked~#contentmain1,
            #tabmain2:checked~#contentmain2 {
                display: block;
            }
        </style>
        <page-panel>
            <div>
                <div class="row around-xs">
                    <div class="col-xs-12 col-md-5">
                        <div class="box">
                            <div class="title">แบบฟอร์มนำเข้าข้อมูล</div>
                        </div>
                        <div class="box">
                            {{searchInput(dataTest)}}
                            <vaadin-combo-box label="บริษัท" items="[[myItem]]" item-label-path="company_name_th" loading="{{check}}" item-value-path="company_taxno"
                                filter="{{dataTest}}" value="{{form.exporter_id}}">
                                <template>
                                    [[item.company_name_th]]
                                </template>
                            </vaadin-combo-box>
                        </div>
                        <div class="box">
                            <vaadin-combo-box label="รายงานการออกส่งออกข้าวไป EU" items="[[listEu]]" value="{{form.quota}}"></vaadin-combo-box>
                        </div>
                        <div class="box">
                            <vaadin-combo-box items="[[year]]" label="ปีโควตา" error-message="กรุณาเลือกปี" value="{{form.year}}"
                                required></vaadin-combo-box>
                        </div>
                        <div class="box">
                            <vaadin-combo-box label="ประเภทข้าว" items="[[typeRice]]" item-label-path="type_rice_name_th" item-value-path="type_rice_id" value="{{form.type_rice_id}}"
                                required>
                                <template>
                                    [[item.type_rice_name_th]]
                                </template>
                            </vaadin-combo-box>
                        </div>
                        <div class="box">
                            <vaadin-combo-box label="เดือนที่รายงาน" items="{{getMonth()}}" item-label-path="name" item-value-path="id" value="{{form.month}}"></vaadin-combo-box>
                        </div>
                        <div class="box">
                            <nylon-input label="ปริมาณการส่งออก" format-number value="{{form.weight}}">
                                <div suffix>ตัน</div>
                            </nylon-input>
                        </div>
                        <div class="box">
                            <paper-input label="เลขที่ใบขน" value="{{form.invoice_id}}"></paper-input>
                        </div>
                        <div class="box">
                            <iron-a11y-keys id="a11y" target="[[target]]" keys="enter" on-keys-pressed="onEnter"></iron-a11y-keys>
                            <paper-input label="เลขที่ใบอนุญาต" id="license"></paper-input>
                            <template is="dom-repeat" items="{{form.license}}">
                                <paper-item class="border">
                                    [[item]] <button on-click="deleteLicense">delete</button>
                                </paper-item>
                            </template>
                        </div>
                        <div class="box">
                            <paper-textarea label="หมายเหตุ" value="{{form.note}}"></paper-textarea>
                        </div>

                    </div>
                    <div class="col-xs-12 col-md-5">
                        <div class="box">
                            <div class="title">อัพโหลดไฟล์เอกสาร</div>
                        </div>
                        <div class="box">
                            <paper-button style="width:100%" disabled="[[checkId(form.id)]]" on-tap="uploadFile" raised>
                                <iron-icon icon="get-app"></iron-icon>
                                upload
                            </paper-button>
                            <input type="file" on-change="changeFile" id="file" hidden multiple accept="application/pdf">
                        </div>
                        <div class="box">
                            <vaadin-grid id="material" items="[[file]]" size="200">
                                <vaadin-grid-column width="50px" flex-grow="0">
                                    <template class="header">
                                        <div class="cell" style="text-align:center;padding:15px">
                                            #
                                        </div>
                                    </template>
                                    <template>
                                        <div class="cell" style="text-align:center;padding:15px">
                                            [[count(index)]]
                                        </div>
                                    </template>
                                </vaadin-grid-column>
                                <vaadin-grid-column>
                                    <template class="header">
                                        <div class="cell">
                                            ชื่อไฟล์
                                        </div>
                                    </template>
                                    <template>
                                        <div class="cell">
                                            [[item.name]]
                                            [[item.0.name]]
                                        </div>
                                    </template>
                                </vaadin-grid-column>
                                <vaadin-grid-column width="120px" flex-grow="0">
                                    <template class="header">
                                        <div class="cell">
                                            จัดการ
                                        </div>
                                    </template>
                                    <template>
                                        <div class="cell">
                                            <paper-icon-button on-tap="loadFile" icon="get-app"></paper-icon-button>
                                            <paper-icon-button on-tap="deleteFile" icon="delete"></paper-icon-button>
                                        </div>
                                    </template>
                                </vaadin-grid-column>
                            </vaadin-grid>
                        </div>
                    </div>
                </div>
                <div class="box">
                    <div class="row end-xs">
                        <div class="col-xs-6">
                            <div class="box">
                                <paper-button class="gl-btn-success" on-tap="getForm">บันทึก</paper-button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </page-panel>
    </template>
    <script>
        Polymer({
            is: 'exporter-report2-form',
            behaviors: [NylonBehavior, ReduxBehavior, MonthBehavior, FormatNumberBehavior],
            observers:['getTypeRice(form.year)'],
            properties: {
                listEu: {
                    type: Array,
                    value: [
                        {
                            value: 'true',
                            label: 'ในโควตา'
                        },
                        {
                            value: 'false',
                            label: 'นอกโควตา'
                        }
                    ]
                },
                myItem: {
                    statePath: 'commonData.companyReport',
                    observer: 'checkItem'
                },
                typeRice: {
                    statePath: 'commonData.type_rice'
                },
                year: {
                    statePath: 'commonData.year'
                },
                form: {
                    statePath: 'exporterReport.form',
                    observer:'updateList'
                },
                select: {
                    type: Object,
                    value: {}
                },
                data: {
                    statePath: 'exporterReport.listUpload'
                },
                file: {
                   statePath:'exporterReport.listUpload'
                }
            },
            ready: function () {
                this.target = this.$.license;
            },
            getTypeRice: function (val) {
                if(val != '' && typeof val != 'undefined'){
                    // console.log('1234')
                    console.log(val)
                    this.dispatchAction('COMMON_DATA_FILTER_TYPE_RICE', val)
                }
            },
            updateList:function(val){
                console.log(val)
                if(val.exporter_id){
                    this.dispatchAction('EXPORTER_REPORT2_GET_LIST','0105532018536');
                }
            },
            checkId:function(val){
                // console.log(val)
                if(typeof val != 'undefined'){
                    return false;
                }
                else {
                    return true;
                }
            },
            count: function (val) {
                return val + 1;
            },
            searchInput: function (value) {
                this.check = true;
                this.debounce('searchItem', () => {
                    // 
                    if (typeof value != 'undefined' && value.length >= 3) {
                        this.dispatchAction('COMMON_DATA_GET_COMPANY_REPORT', value);
                    }
                    else {
                        console.log('clear')
                        this.dispatchAction('COMMON_DATA_GET_COMPANY_CLEAR');
                    }

                }, 500)
            },
            onEnter: function (e) {
                if (this.target.value) {
                    if (typeof this.form.license == 'undefined') this.set('form.license', []);
                    this.push('form.license', this.target.value);
                    this.dispatchAction('EXPORTER_REPORT_UPDATE_LICENSE_LIST', { data: this.form.license })
                    this.target.value = '';
                }
            },
            deleteLicense: function (e) {
                this.splice('form.license', e.model.index, 1)
                this.dispatchAction('EXPORTER_REPORT_UPDATE_LICENSE_LIST', { data: this.form.license })
            },
            loadFile:function(e){
                 window.open('/api/exporterReport/showFile?id='+e.model.item.file_id, '_blank');
            },
            deleteFile: function (e) {
                console.log(e.model.item.file_id);
                this.fire('toast',{status:'load'});
                this.dispatchAction('EXPORTER_REPORT2_DELETE_FILE',e.model.item.file_id)
                .then(()=>{
                    this.fire('toast',{status:'success',text:'ลบข้อมูลสำเร็จ',
                      callback:()=>{
                           this.dispatchAction('EXPORTER_REPORT_LIST_UPLOAD', this.form.id);
                      }
                     });
                   
                })
            },
            checkItem: function () {
                this.check = false;
            },
            getForm: function () {
                this.form.type_doc = 'n';
                var form = this.form;
                if (this.form.quota == 'true') form.quota = true;
                else form.quota = false;
                form.month = parseInt(this.form.month);
                form.year = parseInt(this.form.year);
                form.weight = this.unFormat(this.form.weight);
                this.select.exporter_id = this.form.exporter_id;
                console.log(this.form.id);
                // this.fire('toast', { status: 'load' });
                if(this.form.id){
                    this.dispatchAction('EXPORTER_REPORT2_UPDATE', form,'0105532018536')
                }
                else{
                    this.dispatchAction('EXPORTER_REPORT2_INSERT', form,'0105532018536')
                }
                // this.fire('update-list');
                
                //     .then((response) => {
                //         // console.log(response.data);
                //         this.select.id = response.data;
                //         this.form.file.map((item, index) => {
                //             this.dispatchAction('EXPORTER_REPORT2_UPLOAD_REPORT', item, this.select, index, this.form.file.length)
                //                 .then(function (res) {
                //                     if (index == (this.form.file.length - 1)) {
                //                         this.fire('toast', {
                //                             status: 'success', text: 'บันทึกสำเร็จ',
                //                             callback: function () {
                //                             }
                //                         });
                //                     }
                //                 }.bind(this))
                //         })

                //         // this.EXPORTER_REPORT_SELECT(response.data);
                //         // this.EXPORTER_REPORT_SEARCH(search);
                //     })
                //     .catch((error) => {
                //         console.log('error');
                //         console.log(error);
                //     })

            },
            uploadFile: function () {
                this.$.file.click();
            },
            changeFile: function (e) {
                console.log(this.form)
                this.fire('toast',{status:'load'});
                this.dispatchAction('EXPORTER_REPORT_UPLOAD_REPORT',e.currentTarget.files,
                {
                    exporter_id:this.form.exporter_id,
                    id:this.form.id
                })
                .then(function (response) {
                    this.fire('toast',{status:'success',text:'บันทึกสำเร็จ',
                      callback:()=>{
                           this.dispatchAction('EXPORTER_REPORT_LIST_UPLOAD',this.form.id);
                      }
                     });
                    // this.target.fire('toast', {
                    //     status: 'success', text: 'โหลดข้อมูลสำเร็จ',
                    //     callback: function () {
                    //         store.dispatch({ type: 'EXPORTER_REPORT_SEARCH', payload: response.data })
                    //     }.bind(this)
                    // });
                    // store.dispatch({ type: 'REPORT_GET_LIST', payload: response.data })
                }.bind(this))
                .catch(function (error) {
                    console.log('error');
                    console.log(error);
                }.bind(this))
                // this.dispatchAction('EXPORTER_REPORT2_UPLOAD_REPORT', e.currentTarget.files)
                // console.log(e.currentTarget.files[0]);
                // this.push('form.insertFile',e.currentTarget.files[0]);
                // this.push('form.files', e.currentTarget.files);
                // console.log(this.file)
            }
        });
    </script>
</dom-module>